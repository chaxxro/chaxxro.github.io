<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chaxxro.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="好记性不如烂键盘">
<meta property="og:type" content="website">
<meta property="og:title" content="也无风雨也无晴">
<meta property="og:url" content="https://chaxxro.github.io/page/30/index.html">
<meta property="og:site_name" content="也无风雨也无晴">
<meta property="og:description" content="好记性不如烂键盘">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="chaxxro">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://chaxxro.github.io/page/30/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/30/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>也无风雨也无晴</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">也无风雨也无晴</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaxxro</p>
  <div class="site-description" itemprop="description">好记性不如烂键盘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">422</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/12/MySql-%E6%9A%82%E6%97%B6%E4%B8%8D%E7%9F%A5%E9%81%93%E6%94%BE%E5%93%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/12/MySql-%E6%9A%82%E6%97%B6%E4%B8%8D%E7%9F%A5%E9%81%93%E6%94%BE%E5%93%AA/" class="post-title-link" itemprop="url">暂时不知道放哪</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-12 20:38:03" itemprop="dateCreated datePublished" datetime="2023-04-12T20:38:03+08:00">2023-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="百万级别的数据删除"><a href="#百万级别的数据删除" class="headerlink" title="百万级别的数据删除"></a>百万级别的数据删除</h2><p>索引文件是单独存在的文件，所以当对数据的增加、修改、删除，都会产生额外的对索引文件的操作，这些操作需要消耗额外的 IO，会降低增改删的执行效率</p>
<p>在删除数据库百万级别数据的时候，删除数据的速度和创建的索引数量是成正比的</p>
<ol>
<li><p>先删除索引</p>
</li>
<li><p>删除数据</p>
</li>
<li><p>重新创建索引</p>
</li>
</ol>
<h2 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h2><ul>
<li><p>InnoDB 是聚集索引，数据文件是和索引放在一起，因此必须要有主键</p>
</li>
<li><p>通过主键查询的效率很高，通过非主键索引查询因为需要先查询到主键，然后再通过主键查询数据，因此效率较低</p>
</li>
<li><p>主键不应该过大，否则其他索引也会很大</p>
</li>
<li><p>InnoDB 支持外键</p>
</li>
<li><p>InnoDB 锁粒度是行锁</p>
</li>
<li><p>InnoDB 支持事务，对于 InnoDB 每一条 SQL 语言都默认封装成事务，自动提交，所以最好把多条 SQL 语言放在 <code>begin</code> 和 <code>commit</code> 之间，组成一个事务</p>
</li>
<li><p>InnoDB 不保存表的具体行数</p>
</li>
<li><p>InnoDB 支持 MVCC</p>
</li>
<li><p>InnoDB 支持 B+ 树索引和自适应哈希索引</p>
</li>
<li><p>InnoDB 是原始数据存储，占用存储更大</p>
</li>
<li><p>InnoDB不支持全文索引，但可以通过插件实现</p>
</li>
</ul>
<h3 id="InnoDB-加锁方式"><a href="#InnoDB-加锁方式" class="headerlink" title="InnoDB 加锁方式"></a>InnoDB 加锁方式</h3><p>对于普通 <code>select</code> 语句，InnoDB 不会加任何锁，事务可以通过显式方式加共享锁或排他锁</p>
<p>对于 <code>update</code>、 <code>delete</code> 和 &#96;insert 语句， InnoDB 会自动加排他锁</p>
<p>InnoDB 在事务执行过程中，使用两阶段锁协议：根据隔离级别在需要的时候自动加锁；在执行 <code>commit</code> 或者 <code>rollback</code> 的时候所有的锁在同一时刻被释放</p>
<h2 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h2><ul>
<li><p>MyISAM 是非聚集索引，数据文件是分离的，索引保存的是数据文件的指针，主键索引和辅助索引是独立的</p>
</li>
<li><p>MyISAM 不支持外键</p>
</li>
<li><p>MyISAM 是表锁</p>
</li>
<li><p>MyISAM 不支持事务，但可以在 service 层进行根据自己的业务需求进行相应的控制</p>
</li>
<li><p>MyISAM 用一个变量保存了整个表行数</p>
</li>
<li><p>MyISAM 不支持 MVCC</p>
</li>
<li><p>MyISAM 支持 B+ 树索引</p>
</li>
<li><p>MyISAM 实现了前缀压缩技术，占用存储空间更小，但会影响查找</p>
</li>
<li><p>MyISAM 支持全文索引</p>
</li>
</ul>
<h3 id="加锁方法"><a href="#加锁方法" class="headerlink" title="加锁方法"></a>加锁方法</h3><p>在执行查询语句前，会自动给涉及的表加读锁，在执行更新操作前，会自动给涉及的表加写锁</p>
<p>在自动加锁的情况下，MyISAM 总是一次获得 SQL 语句所需要的全部锁</p>
<p>MyISAM 存储引擎支持并发插入，以减少的读和写操作之间的冲突：如果 MyISAM 表在数据文件中间没有空闲块，则行始终插入数据文件的末尾；可以在其他线程进行读操作的时候，同时将行插入到 MyISAM 表中；文件中间的空闲块可能是从表格中间删除或更新的行而产生的，如果文件中间有空闲块，则并发插入会被禁用，但是当所有空闲块都填充有新数据时，它又会自动重新启用</p>
<h2 id="快照读和当前读"><a href="#快照读和当前读" class="headerlink" title="快照读和当前读"></a>快照读和当前读</h2><h3 id="快照读"><a href="#快照读" class="headerlink" title="快照读"></a>快照读</h3><p>在 READ COMMITTED 和 REPEATABLE READ 隔离级别下，普通的 SELECT 查询都是读取 MVCC 版本链中的一个版本，相当于读取一个快照，因此称为快照读；这种读取方式不会加锁，因此读操作时非阻塞的，因此也叫非阻塞读</p>
<h3 id="当前读"><a href="#当前读" class="headerlink" title="当前读"></a>当前读</h3><p>读取的是当前最新版本，称为当前读；当前读不仅会对当前记录加行记录锁，还会对查询范围空间的数据加间隙锁</p>
<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><p>触发器是与表有关的数据库对象，在满足定义条件时触发，并执行触发器中定义的语句集合，使用触发器可以保证某些操作之间的一致性</p>
<p>能决定触发器执行某个操作的事件有：insert、update 和 delete</p>
<p>不能在同一张表上建立 2 种同类型的触发器，一张表最多创建 6 个触发器(6 种类型)：即 BEFORE INSERT、BEFORE UPDATE、BEFORE DELETE、AFTER INSERT、AFTER UPDATE、AFTER DELETE</p>
<p>在 INSERT 型触发器中，NEW 用来表示将要（BEFORE）或已经（AFTER）插入的新数据</p>
<p>在 UPDATE 型触发器中，OLD 用来表示将要或已经被修改的原数据，NEW 用来表示将要或已经修改为的新数据</p>
<p>在 DELETE 型触发器中，OLD 用来表示将要或已经被删除的原数据</p>
<p>OLD 是只读的，而 NEW 则可以在触发器中使用 SET 赋值，这样不会再次触发触发器，造成循环调用</p>
<p>多个执行语句则用 BEGIN、END 包围</p>
<p>触发器基于行触发，当对整个表进行操作时效果较差</p>
<p>在基于锁的操作中，触发器可能会导致锁等待或死锁；触发器执行失败，原来执行的 SQL 语句也会执行失败</p>
<h2 id="主从同步"><a href="#主从同步" class="headerlink" title="主从同步"></a>主从同步</h2><p>为了减轻数据库压力，需要对数据库做读写分离和主从同步，写操作走主库，读操作走从库，分散了数据库的访问压力，提升整个系统的性能和可用性</p>
<img src="/2023/04/12/MySql-%E6%9A%82%E6%97%B6%E4%B8%8D%E7%9F%A5%E9%81%93%E6%94%BE%E5%93%AA/01.png" class="">

<h3 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h3><p>主从复制需要三个线程，master（binlog dump thread）、slave（I&#x2F;O thread 、SQL thread）</p>
<ul>
<li><p>master 库 binlog dump 线程：当主库中有数据更新时，会将此次更新的事件类型写入到主库的 binlog 文件中，此时主库会创建 log dump 线程通知 slave 有数据更新，当 I&#x2F;O 线程请求日志内容时，会将此时的 binlog 名称和当前更新的位置同时传给 slave 的 I&#x2F;O 线程</p>
</li>
<li><p>slave 库 I&#x2F;0 线程：该线程会连接到 master，向 log dump 线程请求一份指定 binlog 文件位置的副本，并将请求回来的 binlog 存到本地的 relay log 中</p>
</li>
<li><p>slave 库 SQL 线程：该线程检测到 relay log 有更新后，会读取并在本地做 redo 操作，将发生在主库的事件在本地重新执行一遍，来保证主从数据同步；如果一个 relay log 文件中的全部事件都执行完毕，那么 SQL 线程会自动将该 relay log 文件删除掉</p>
</li>
</ul>
<img src="/2023/04/12/MySql-%E6%9A%82%E6%97%B6%E4%B8%8D%E7%9F%A5%E9%81%93%E6%94%BE%E5%93%AA/02.png" class="">
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/11/SQL-%E5%87%BD%E6%95%B0%E5%92%8C%E6%93%8D%E4%BD%9C%E7%AC%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/11/SQL-%E5%87%BD%E6%95%B0%E5%92%8C%E6%93%8D%E4%BD%9C%E7%AC%A6/" class="post-title-link" itemprop="url">函数和操作符</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-11 22:12:42" itemprop="dateCreated datePublished" datetime="2023-04-11T22:12:42+08:00">2023-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:20" itemprop="dateModified" datetime="2023-09-21T12:04:20+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="字符串比较"><a href="#字符串比较" class="headerlink" title="字符串比较"></a>字符串比较</h2><h3 id="like"><a href="#like" class="headerlink" title="like"></a>like</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expr <span class="keyword">like</span> pat [<span class="keyword">escape</span> <span class="string">&#x27;ch&#x27;</span>]</span><br><span class="line">expr <span class="keyword">not</span> <span class="keyword">like</span> pat [excape <span class="string">&#x27;ch&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>返回 0 或 1</p>
</li>
<li><p><code>%</code> 匹配任意字符，<code>_</code> 匹配任意单个字符</p>
</li>
<li><p>默认使用 <code>\</code> 进行转义，也可以通过 <code>escape &#39;ec&#39;</code> 指定转义符</p>
</li>
</ul>
<h3 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp"></a>strcmp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcmp(expr1, expr2)</span><br></pre></td></tr></table></figure>

<p>两个字符串相等时返回 0，<code>expr1</code> 小于 <code>expr2</code> 时返回 -1，否则返回 1</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/11/LeetCode-sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/11/LeetCode-sql/" class="post-title-link" itemprop="url">sql</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-11 20:47:27" itemprop="dateCreated datePublished" datetime="2023-04-11T20:47:27+08:00">2023-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="最晚入职员工所有信息"><a href="#最晚入职员工所有信息" class="headerlink" title="最晚入职员工所有信息"></a>最晚入职员工所有信息</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employees` (</span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,  <span class="comment">-- &#x27;员工编号&#x27;</span></span><br><span class="line">`birth_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`first_name` <span class="type">varchar</span>(<span class="number">14</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`last_name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`gender` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`hire_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> hire_date <span class="operator">=</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">max</span>(hire_date) <span class="keyword">from</span> employees</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">order</span> <span class="keyword">by</span> hire_date <span class="keyword">desc</span> limit <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"># 入职时间倒数第三的员工所有信息</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">order</span> <span class="keyword">by</span> hire_date <span class="keyword">desc</span> limit <span class="number">1</span> <span class="keyword">offset</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="各个部门当前领导当前薪水和部门"><a href="#各个部门当前领导当前薪水和部门" class="headerlink" title="各个部门当前领导当前薪水和部门"></a>各个部门当前领导当前薪水和部门</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `salaries` (</span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">-- &#x27;员工编号&#x27;,</span></span><br><span class="line">`salary` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`from_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`to_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`,`from_date`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dept_manager` (</span><br><span class="line">`dept_no` <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">-- &#x27;部门编号&#x27;</span></span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">--  &#x27;员工编号&#x27;</span></span><br><span class="line">`to_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`,`dept_no`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.<span class="operator">*</span>, b.dept_no <span class="keyword">from</span> salaries a <span class="keyword">left</span> <span class="keyword">join</span> dept_manager b </span><br><span class="line"><span class="keyword">on</span> a.from_date <span class="operator">=</span> b.from_date</span><br><span class="line"><span class="keyword">where</span> a.from_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> a.emp_no; </span><br></pre></td></tr></table></figure>

<h2 id="所有员工入职时薪水情况"><a href="#所有员工入职时薪水情况" class="headerlink" title="所有员工入职时薪水情况"></a>所有员工入职时薪水情况</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employees` (</span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`birth_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`first_name` <span class="type">varchar</span>(<span class="number">14</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`last_name` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`gender` <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`hire_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `salaries` (</span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`salary` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`from_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`to_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`,`from_date`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> emp_no, salary <span class="keyword">from</span> salaries</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> emp_no <span class="keyword">having</span> salary <span class="operator">&lt;=</span> <span class="built_in">min</span>(salary)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> emp_no <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.emp_no, b.salary <span class="keyword">from</span> employees a, salaries b</span><br><span class="line"><span class="keyword">where</span> a.emp_no <span class="operator">=</span> b.emp_no <span class="keyword">and</span> a.hire_date <span class="operator">=</span> b.from_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a.emp_no <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h2 id="薪水变动超过-15-次的员工"><a href="#薪水变动超过-15-次的员工" class="headerlink" title="薪水变动超过 15 次的员工"></a>薪水变动超过 15 次的员工</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `salaries` (</span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`salary` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`from_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`to_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`,`from_date`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> emp_no, <span class="built_in">count</span>(emp_no) t <span class="keyword">from</span> salaries</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> emp_no <span class="keyword">having</span> <span class="built_in">count</span>(emp_no) <span class="operator">&gt;</span> <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line"># 所有员工当前薪水情况</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> salary <span class="keyword">from</span> salaries</span><br><span class="line"><span class="keyword">where</span> to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h2 id="获取员工的经理"><a href="#获取员工的经理" class="headerlink" title="获取员工的经理"></a>获取员工的经理</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dept_emp` (</span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">-- &#x27;所有的员工编号&#x27;</span></span><br><span class="line">`dept_no` <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">-- &#x27;部门编号&#x27;</span></span><br><span class="line">`from_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`to_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`,`dept_no`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dept_manager` (</span><br><span class="line">`dept_no` <span class="type">char</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">-- &#x27;部门编号&#x27;</span></span><br><span class="line">`emp_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="comment">-- &#x27;经理编号&#x27;</span></span><br><span class="line">`from_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`to_date` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`emp_no`,`dept_no`));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.emp_no, b.emp_no manager_no <span class="keyword">from</span></span><br><span class="line">dept_emp a, dept_manager b</span><br><span class="line"><span class="keyword">where</span> b.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span> </span><br><span class="line"><span class="keyword">and</span> a.dept_no <span class="operator">=</span> b.dept_no</span><br><span class="line"><span class="keyword">and</span> a.emp_no <span class="operator">!=</span> b.emp_no;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> a.emp_no, b.emp_no manager_no <span class="keyword">from</span></span><br><span class="line">dept_emp a <span class="keyword">inner</span> <span class="keyword">join</span> dept_manager b</span><br><span class="line"><span class="keyword">on</span> a.dept_no <span class="operator">=</span> b.dept_no</span><br><span class="line"><span class="keyword">where</span> b.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span> </span><br><span class="line"><span class="keyword">and</span> a.emp_no <span class="operator">!=</span> b.emp_no;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/10/SQL-sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/10/SQL-sql/" class="post-title-link" itemprop="url">sql</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-10 10:54:23" itemprop="dateCreated datePublished" datetime="2023-04-10T10:54:23+08:00">2023-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:20" itemprop="dateModified" datetime="2023-09-21T12:04:20+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>sql(structured query language) 是结构化查询语言</p>
<p>sql 主要由六个子语言组成：</p>
<ul>
<li><p>DDL(Data Definition Language) 数据定义语言，用于定义数据库的三级结构，包括外模式、概念模式、内模式及其相互之间的映像，定义数据的完整性约束、安全控制等。DDL 不需要 commit，常用关键字有： <code>CREATE</code>、<code>ALTER</code>、<code>DROP</code>、<code>TRUNCATE</code>、<code>COMMENT</code>、<code>RENAME</code></p>
</li>
<li><p>DQL(Data Query Language) 数据查询语言，用以从表中获得数据，确定数据怎样在应用程序给出。常用的关键字有：<code>SELECT</code>、<code>FROM</code>、<code>WHERE</code>、<code>GROUP BY</code>、<code>HAVING</code>、<code>ORDER BY</code>、<code>LIMIT</code>、<code>UNION</code>、<code>JOIN</code></p>
</li>
<li><p>DML(Data Manipulation Language) 数据操作语言，供用户对数据库中数据的操作，包括数据的增加、删除、更新，载入等操作。常用关键字有：<code>UPDATE</code>、<code>DELETE</code>、<code>INSERT INTO</code>、<code>LOAD</code></p>
</li>
<li><p>DCL(Data Control Language) 数据控制语言，用于对数据库，数据表的访问角色和权限的控制等。常用关键字有：<code>GRANT</code>、<code>REVOKE</code>、<code>DENY</code></p>
</li>
<li><p>TCL(Transaction Control Language) 事务控制语言，又名 TPL(Transaction Process Language) 事务处理语言，它能确保被 DML 语句影响的表的所有行及时得以更新。常用关键字有：<code>START TRANSACTION</code>、<code>BEGIN</code>、<code>SAVEPOINT</code>、<code>ROLLBACK</code>、<code>COMMIT</code>、<code>SET TRANSACTION</code></p>
</li>
<li><p>CCL(Cursor Control Language) 游标控制语言，游标 cursor 是 DBMS 为用户开设的一个数据缓冲区，存放 SQL 语句的执行结果。常用关键字有：<code>DECLARE CURSOR</code>、<code>OPEN CURSOR</code>、<code>FETCH INTO</code>、<code>UPDATE WHERE CURRENT</code>、<code>CLOSE CURSOR</code></p>
</li>
</ul>
<h2 id="DCL"><a href="#DCL" class="headerlink" title="DCL"></a>DCL</h2><h3 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> username<span class="variable">@host</span> [identified <span class="keyword">by</span> password]</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> xx<span class="variable">@localhost</span> identified <span class="keyword">by</span> <span class="string">&#x27;xx&#x27;</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> xx<span class="variable">@192</span><span class="number">.168</span><span class="number">.1</span><span class="number">.1</span> identified <span class="keyword">by</span> <span class="string">&#x27;xx&#x27;</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> xx@&quot;%&quot; identified <span class="keyword">by</span> <span class="string">&#x27;xx&#x27;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> xx@&quot;%&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>username</code> 用户名</p>
</li>
<li><p><code>host</code> 指定该用户可以在哪台主机登陆，本地可以使用 <code>localhost</code>，任意主机可以使用 <code>%</code></p>
</li>
<li><p><code>password</code> 表示用户密码</p>
</li>
</ul>
<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> username<span class="variable">@host</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> xx<span class="variable">@localhost</span></span><br></pre></td></tr></table></figure>

<h3 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> privileges <span class="keyword">on</span> databasename.tablename <span class="keyword">to</span> username<span class="variable">@host</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> xx@<span class="string">&#x27;%&#x27;</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> xx@<span class="string">&#x27;%&#x27;</span></span><br><span class="line"></span><br><span class="line"># 刷新一下权限</span><br><span class="line">flush privileges</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>privileges</code> 是一个用逗号分隔的赋予 MySQL 用户的权限列表，如 <code>select</code>、<code>insert</code>、<code>update</code> 等，如果要授予所有的权限则使用 <code>all</code></p>
</li>
<li><p><code>databasename</code> 数据库名，<code>tablename</code> 表名，如果要授予该用户对所有数据库和表的相应操作权限则可用 <code>*</code> 表示，如 <code>*.*</code></p>
</li>
<li><p>使用 <code>grant</code> 为用户授权时，如果指定的用户不存在，则会新建该用户并授权</p>
</li>
</ul>
<p>设置允许用户远程访问 MySQL 服务器时，一般使用该命令，并指定密码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> xx@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="撤销权限"><a href="#撤销权限" class="headerlink" title="撤销权限"></a>撤销权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> privileges <span class="keyword">on</span> databasename.tableanme <span class="keyword">from</span> username<span class="variable">@host</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">revoke</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> xx@<span class="string">&#x27;%&#x27;</span></span><br><span class="line"><span class="keyword">revoke</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> xx@<span class="string">&#x27;%&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="查看权限"><a href="#查看权限" class="headerlink" title="查看权限"></a>查看权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 从 mysql.user 表中查看</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;username&#x27;</span></span><br><span class="line"></span><br><span class="line"># 从授权信息中查看</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> username<span class="variable">@host</span></span><br></pre></td></tr></table></figure>

<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> password <span class="keyword">for</span> username<span class="variable">@host</span><span class="operator">=</span> password(newpassword)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> password <span class="keyword">for</span> xx<span class="variable">@localhost</span><span class="operator">=</span>password(&quot;1234&quot;)</span><br><span class="line"># 修改当前用户密码</span><br><span class="line"><span class="keyword">set</span> password <span class="operator">=</span> password(&quot;1234&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database databasename</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> database Student</span><br></pre></td></tr></table></figure>

<h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> database databasename</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> database Student</span><br></pre></td></tr></table></figure>

<h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查看全部数据库</span><br><span class="line"><span class="keyword">show</span> databases</span><br><span class="line"></span><br><span class="line"># 查看当前数据库</span><br><span class="line"># <span class="number">1</span></span><br><span class="line"><span class="keyword">select</span> database()</span><br><span class="line"># <span class="number">2</span></span><br><span class="line">status</span><br></pre></td></tr></table></figure>

<h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use databasename</span><br></pre></td></tr></table></figure>

<h3 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tablename (</span><br><span class="line">  filed1 type1 [<span class="keyword">is</span> <span class="keyword">null</span>] [key] [<span class="keyword">default</span> <span class="keyword">value</span>] [extra] [comment],</span><br><span class="line">  ...</span><br><span class="line">)[engine] [charset]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>除了表名，字段名和字段类型，其它都是可选参数，可有可无，根据实际情况来定</p>
</li>
<li><p><code>is null</code> 表示该字段是否允许为空，不指明，默认允许为 <code>NULL</code></p>
</li>
<li><p><code>key</code> 表示该字段是否是主键，外键，唯一键还是索引</p>
</li>
<li><p><code>default value</code> 表示该字段在未显示赋值时的默认值</p>
</li>
<li><p><code>extra</code> 表示其它的一些修饰，比如自增 <code>auto_increment[=value]</code></p>
</li>
<li><p><code>comment</code> 表示对该字段的说明注释</p>
</li>
<li><p><code>engine</code> 表示数据库存储引擎，MySQL 支持的常用引擎有 ISAM、MyISAM、Memory、InnoDB 和 BDB，不显示指明默认使用 MyISAM</p>
</li>
<li><p><code>charset</code> 表示数据表数据存储编码格式，默认为 latin1</p>
</li>
</ul>
<h3 id="创建临时表"><a href="#创建临时表" class="headerlink" title="创建临时表"></a>创建临时表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> temporary <span class="keyword">table</span> tablename (</span><br><span class="line">  ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建临时表与创建普通表的语句基本是一致的，只是多了一个 <code>temporary</code> 关键字</p>
</li>
<li><p>临时表的特点是：表结构和表数据都是存储到内存中的，生命周期是当前 MySQL 会话，会话结束后，临时表自动被 drop</p>
</li>
<li><p>临时表与 Memory 表的区别是：Memory 表的表结构存储在磁盘，临时表的表结构存储在内存；<code>show tables</code> 看不到临时表，看得到内存表；内存表的生命周期是服务端 MySQL 进程生命周期，MySQL 重启或者关闭后内存表里的数据会丢失，但是表结构仍然存在，而临时表的生命周期是 MySQL 客户端会话；内存表支持唯一索引，临时表不支持唯一索引；在不同会话可以创建同名临时表，不能创建同名内存表</p>
</li>
</ul>
<h3 id="创建内存表"><a href="#创建内存表" class="headerlink" title="创建内存表"></a>创建内存表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> temporary <span class="keyword">table</span> tablename (</span><br><span class="line">  ...</span><br><span class="line">) engine<span class="operator">=</span>memory</span><br></pre></td></tr></table></figure>

<h3 id="删除数据表"><a href="#删除数据表" class="headerlink" title="删除数据表"></a>删除数据表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> tablename</span><br></pre></td></tr></table></figure>

<h3 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> tablename</span><br></pre></td></tr></table></figure>

<h3 id="查看建表语句"><a href="#查看建表语句" class="headerlink" title="查看建表语句"></a>查看建表语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> tablename</span><br></pre></td></tr></table></figure>

<h3 id="重命名数据表"><a href="#重命名数据表" class="headerlink" title="重命名数据表"></a>重命名数据表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="keyword">table</span> tablename <span class="keyword">to</span> newtablename</span><br></pre></td></tr></table></figure>

<h3 id="列操作"><a href="#列操作" class="headerlink" title="列操作"></a>列操作</h3><ul>
<li>删除列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename <span class="keyword">drop</span> <span class="keyword">column</span> columnname</span><br></pre></td></tr></table></figure>

<ul>
<li>增加列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename <span class="keyword">add</span> <span class="keyword">column</span> columnname columndefinition</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> <span class="keyword">column</span> hometown <span class="type">varchar</span>(<span class="number">32</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>重命名列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename change columnname newcolumnname type</span><br></pre></td></tr></table></figure>

<ul>
<li>修改列属性</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename modify columnname newdefinition</span><br></pre></td></tr></table></figure>

<p><code>change</code> 可以更改列名和列类型，但每次都要把新列名和旧列名写上，即使两个列名没有更改</p>
<p><code>modify</code> 只能更改列属性，但只需要写一次列名</p>
<h3 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h3><ul>
<li>增加索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename <span class="keyword">add</span> index [indexname](filed1, filed2,...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> index index_studentNo(studentNo)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> index(studentNo)</span><br></pre></td></tr></table></figure>

<ul>
<li>查看索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> tablename</span><br></pre></td></tr></table></figure>

<ul>
<li>删除索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename <span class="keyword">drop</span> index indexname</span><br></pre></td></tr></table></figure>

<h3 id="修改存储引擎"><a href="#修改存储引擎" class="headerlink" title="修改存储引擎"></a>修改存储引擎</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tablename type engine<span class="operator">=</span>enginename</span><br></pre></td></tr></table></figure>

<h2 id="DQL"><a href="#DQL" class="headerlink" title="DQL"></a>DQL</h2><h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> filed1,... [<span class="keyword">from</span> table1,...] [<span class="keyword">where</span> ...] [<span class="keyword">group</span> <span class="keyword">by</span> ...] [<span class="keyword">having</span> ...] [<span class="keyword">order</span> <span class="keyword">by</span> ...] [limit n] [<span class="keyword">offset</span> m] </span><br></pre></td></tr></table></figure>

<ul>
<li><p>一个 <code>select</code> 语句中，子句的顺序是固定的，必须是 <code>from</code>、<code>where</code>、<code>group by</code>、<code>having</code>、<code>order by</code>、<code>limit</code>、<code>offset</code></p>
</li>
<li><p>每个子句执行后都会产生一个中间数据结果，即所谓的临时视图，供接下来的子句使用，如果不存在某个子句就跳过</p>
</li>
<li><p><code>where</code> 子句的字符串比较如果不使用 <code>like</code> 是不区分大小写的，可以使用 <code>binary</code> 来设定 <code>where</code> 子句的字符串比较是区分大小写的</p>
</li>
</ul>
<h3 id="结果排序"><a href="#结果排序" class="headerlink" title="结果排序"></a>结果排序</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> field1 [<span class="keyword">asc</span> <span class="operator">|</span> <span class="keyword">desc</span>],...</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以使用任何字段来作为排序的字段，从而返回排序后的查询结果</p>
</li>
<li><p>可以设定多个字段来排序</p>
</li>
<li><p>可以使用 <code>asc</code> 或 <code>desc</code> 关键字来设置查询结果是按升序或降序排列，默认情况下，它是按升序排列</p>
</li>
<li><p>多列排序的时候，先对第一个字段进行排序，然后对于相同的第一字段内部再采用第一个字段进行排序，以此类推</p>
</li>
</ul>
<h3 id="结果分组"><a href="#结果分组" class="headerlink" title="结果分组"></a>结果分组</h3><p><code>group by</code> 配合统计函数，对结果集中的列进行分组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group by columnname</span><br></pre></td></tr></table></figure>

<h3 id="结果聚合"><a href="#结果聚合" class="headerlink" title="结果聚合"></a>结果聚合</h3><p><code>union</code> 用于连接两个以上的 <code>select</code> 语句的结果组合到一个结果集合中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> expression1, expression2, ... expression_n</span><br><span class="line"><span class="keyword">from</span> tables</span><br><span class="line">[<span class="keyword">where</span> conditions]</span><br><span class="line"><span class="keyword">union</span> [<span class="keyword">all</span> <span class="operator">|</span> <span class="keyword">distinct</span>]</span><br><span class="line"><span class="keyword">select</span> expression1, expression2, ... expression_n</span><br><span class="line"><span class="keyword">from</span> tables</span><br><span class="line">[<span class="keyword">where</span> conditions];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>每个查询必须包含相同的列、表达式或者聚合函数，但它们出现的顺序可以不一致</p>
</li>
<li><p>默认值 <code>distinct</code> 删除结果集中重复的数据，<code>all</code> 返回包含重复数据的结果集</p>
</li>
<li><p>只能使用一条 <code>order by</code> 对结果集进行排序，而且必须出现在最后一条出现的 <code>select</code> 语句之后</p>
</li>
<li><p>多表查询的时候并不要求两个表完全相同，只需要检索的字段结构相似</p>
</li>
</ul>
<h3 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h3><ul>
<li>inner join 获取两个表中字段匹配关系的记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.column1, a.column2, b.column1 <span class="keyword">from</span> tab1 a <span class="keyword">inner</span> <span class="keyword">join</span> tab2 b <span class="keyword">on</span> a.column1 <span class="operator">=</span> b.column1;</span><br></pre></td></tr></table></figure>

<img src="/2023/04/10/SQL-sql/01.png" class="">

<ul>
<li>left join 获取左表所有记录，即使右表没有对应匹配的记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.column1, a.column2, b.column1 <span class="keyword">from</span> tab1 a <span class="keyword">left</span> <span class="keyword">join</span> tab2 b <span class="keyword">on</span> a.column1 <span class="operator">=</span> b.column1;</span><br></pre></td></tr></table></figure>

<img src="/2023/04/10/SQL-sql/02.png" class="">

<ul>
<li>right join 获取右表所有记录，即使左表没有对应匹配的记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.column1, a.column2, b.column1 <span class="keyword">from</span> tab1 a <span class="keyword">right</span> <span class="keyword">join</span> tab2 b <span class="keyword">on</span> a.column1 <span class="operator">=</span> b.column1;</span><br></pre></td></tr></table></figure>

<img src="/2023/04/10/SQL-sql/03.png" class="">

<ul>
<li>full outer join 只要左表和右表其中一个表中存在匹配</li>
</ul>
<img src="/2023/04/10/SQL-sql/04.png" class="">

<img src="/2023/04/10/SQL-sql/05.png" class="">

<h2 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h2><h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tablename(column1,column2,...) <span class="keyword">values</span>(value1,value2,...)</span><br><span class="line"></span><br><span class="line"># 如果插入值刚好与数据表的所有列一一对应，那么可以省略书写插入的指定列</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tablename <span class="keyword">values</span>(value1,value2,...)</span><br></pre></td></tr></table></figure>

<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tablename <span class="keyword">where</span> <span class="keyword">condition</span></span><br></pre></td></tr></table></figure>

<h3 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> tablename <span class="keyword">set</span> columnname<span class="operator">=</span>newvalue,... <span class="keyword">where</span> <span class="keyword">condition</span></span><br></pre></td></tr></table></figure>

<h3 id="备份数据"><a href="#备份数据" class="headerlink" title="备份数据"></a>备份数据</h3><ul>
<li>导出数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump <span class="operator">-</span>u username <span class="operator">-</span>p databasename [tablename] <span class="operator">&gt;</span> output.sql</span><br></pre></td></tr></table></figure>

<ul>
<li>还原数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source file.sql</span><br></pre></td></tr></table></figure>

<ul>
<li>导出 csv 文件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tablename <span class="keyword">into</span> outfile &quot;file.csv&quot;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tablename <span class="keyword">into</span> outfile &quot;file.csv&quot; fields terminated <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span> optionally enclosed <span class="keyword">by</span> <span class="string">&#x27;&quot;&#x27;</span> lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>导入 csv 文件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data infile &quot;/path/to/file.csv&quot; <span class="keyword">into</span> <span class="keyword">table</span> tablename</span><br></pre></td></tr></table></figure>

<h2 id="TCL"><a href="#TCL" class="headerlink" title="TCL"></a>TCL</h2><h3 id="查看事务模式"><a href="#查看事务模式" class="headerlink" title="查看事务模式"></a>查看事务模式</h3><p>MySQL 默认操作模式就是 autocommit 自动提交模式</p>
<p>自动提交事务由环境变量 <code>autocommit</code> 来控制，该变量只对当前会话有效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@global</span>.autocommit</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> &quot;%autocommit%&quot;</span><br></pre></td></tr></table></figure>

<p><code>autocommit</code> 默认值是 1，表示在命令行模式下每条增删改语句在键入回车后，都会立即生效，而不需要手动 commit</p>
<h3 id="关闭-x2F-开启自动提交事务"><a href="#关闭-x2F-开启自动提交事务" class="headerlink" title="关闭&#x2F;开启自动提交事务"></a>关闭&#x2F;开启自动提交事务</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 开启当前会话的自动提交事务</span><br><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"># 关闭当前会话的自动提交事务</span><br><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"># 永久关闭</span><br><span class="line"># 通过修改配置文件 my.cnf 文件，添加配置项</span><br><span class="line">autocommit<span class="operator">=</span><span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="事务控制"><a href="#事务控制" class="headerlink" title="事务控制"></a>事务控制</h3><ul>
<li>开启事务</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span></span><br><span class="line"><span class="keyword">start</span> transaction</span><br><span class="line"></span><br><span class="line"># <span class="number">2</span></span><br><span class="line"><span class="keyword">begin</span></span><br></pre></td></tr></table></figure>

<ul>
<li>提交事务</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">commit</span></span><br></pre></td></tr></table></figure>

<ul>
<li>回滚</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">rollback</span></span><br></pre></td></tr></table></figure>

<ul>
<li>保存点</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个保存点</span><br><span class="line"><span class="keyword">savepoint</span> pointname</span><br><span class="line"></span><br><span class="line"># 删除一个保存点</span><br><span class="line"><span class="keyword">release</span> <span class="keyword">savepoint</span> pointname</span><br><span class="line"></span><br><span class="line"># 回滚保存点</span><br><span class="line"><span class="keyword">rollback</span> <span class="keyword">to</span> pointname</span><br></pre></td></tr></table></figure>

<h3 id="事务等级"><a href="#事务等级" class="headerlink" title="事务等级"></a>事务等级</h3><ul>
<li>查看事务等级</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看全局事务等级</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@global</span>.tx_isolation</span><br><span class="line"></span><br><span class="line"># 查看当前会话事务等级</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@session</span>.tx_isolation</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx</span>_isolation</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;tx_isolation&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>设置事务等级</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> scopename transaction isolation level txlevel</span><br><span class="line"># scopename 包括 <span class="keyword">global</span> 和 session，默认值 session</span><br><span class="line"># txlevel 包括 read uncommitted、read committed、repeatable read、serializable</span><br><span class="line"># InnoDB 默认事务等级是 repeatable read</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/09/MySql-%E8%A1%A8%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/09/MySql-%E8%A1%A8%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">表数据</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-09 15:16:54" itemprop="dateCreated datePublished" datetime="2023-04-09T15:16:54+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一个 InnoDB 表包含表结构定义和数据</p>
<p>每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中</p>
<p>一个表单独存储为一个文件更容易管理，在不需要这个表时通过 drop table 命令，系统就会直接删除这个文件</p>
<h2 id="数据删除流程"><a href="#数据删除流程" class="headerlink" title="数据删除流程"></a>数据删除流程</h2><p>删除某行数据时，InnoDB 引擎只会把记录标记为删除，之后要再插入一个记录时，可能会复用这个位置，磁盘文件的大小并不会因为删除而缩小</p>
<p>同理，删掉一个数据页上的所有记录，整个数据页都可以被复用</p>
<p>但是，数据页的复用跟记录的复用是不同的。记录的复用，只限于符合范围条件的数据，而当整个页从 B+ 树里面摘掉以后，可以复用到任何位置</p>
<p>如果相邻的两个数据页利用率都很小，系统就会把这两个页上的数据合到其中一个页上，另外一个数据页就被标记为可复用</p>
<p>如果用 delete 命令把整个表的数据删除，所有的数据页都会被标记为可复用，但是磁盘上文件不会变小</p>
<p>不止是删除数据会造成空洞，插入数据也会；如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂</p>
<img src="/2023/04/09/MySql-%E8%A1%A8%E6%95%B0%E6%8D%AE/01.png" class="">

<p>更新索引上的值，可以理解为删除一个旧的值，再插入一个新值</p>
<h2 id="重建表"><a href="#重建表" class="headerlink" title="重建表"></a>重建表</h2><p>经过大量增删改的表，都是可能是存在空洞的。所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的</p>
<p>可以使用 alter table A engine&#x3D;InnoDB 命令来重建表，该命令执行流程为新建一个与表 A 结构相同的表 B，然后按照主键 ID 递增的顺序，把数据一行一行地从表 A 里读出来再插入到表 B 中；这个临时表 B 不需要手动创建，MySQL 会自动完成转存数据、交换表名、删除旧表的操作；数据搬运过程中，有新的数据要写入到表 A 的话，就会造成数据丢失</p>
<p>MySQL 5.6 版本开始引入的 Online DDL，对这个操作流程做了优化</p>
<ol>
<li><p>建立一个临时文件，扫描表 A 主键的所有数据页</p>
</li>
<li><p>用数据页中表 A 的记录生成 B+ 树，存储到临时文件中</p>
</li>
<li><p>生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态</p>
</li>
<li><p>临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件</p>
</li>
<li><p>用临时文件替换表 A 的数据文件</p>
</li>
</ol>
<p>由于日志文件记录和重放操作这个功能的存在，这个方案在重建表的过程中，允许对表 A 做增删改操作</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/09/MySql-%E6%8E%92%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/09/MySql-%E6%8E%92%E5%BA%8F/" class="post-title-link" itemprop="url">排序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-09 15:16:18" itemprop="dateCreated datePublished" datetime="2023-04-09T15:16:18+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="全字段排序"><a href="#全字段排序" class="headerlink" title="全字段排序"></a>全字段排序</h2><p>MySQL 会给每个线程分配一块内存用于排序，称为 sort_buffer，对 sort_buffer 中的数据按照 <code>order by</code> 字段做快速排序</p>
<p>按字段排序这个动作，可能在内存中完成，也可能需要使用外部排序，这取决于排序所需的内存和参数 sort_buffer_size</p>
<p>sort_buffer_size 就是 MySQL 为排序开辟的内存（sort_buffer）的大小。如果要排序的数据量小于 sort_buffer_size，排序就在内存中完成。但如果排序数据量太大，内存放不下，则不得不利用磁盘临时文件辅助排序</p>
<p>内存放不下时，就需要使用外部排序，外部排序一般使用归并排序算法，将需要排序的数据分成 number_of_tmp_files 份，每一份单独排序后存在这些临时文件中，然后把这 nnumber_of_tmp_files 个有序文件再合并成一个有序的大文件</p>
<p>sort_buffer_size 越小，需要分成的份数越多，number_of_tmp_files 的值就越大</p>
<h2 id="rowid-排序"><a href="#rowid-排序" class="headerlink" title="rowid 排序"></a>rowid 排序</h2><p>如果查询要返回的字段很多的话，那么 sort_buffer 里面要放的字段数太多，这样内存里能够同时放下的行数很少，要分成很多个临时文件，排序的性能会很差</p>
<p>如果排序的单行长度太大，放入 sort_buffer 的字段就只有要排序的列和主键 id，但此时排序的结果就因为少了字段的值，不能直接返回，而是排序后再根据主键 id 从原表中取出所有字段并返回</p>
<p>MySQL 服务端从排序后的 sort_buffer 中依次取出 id，然后到原表查到相应字段的结果，不需要在服务端再耗费内存存储结果，是直接返回给客户端的</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/09/MySql-mvcc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/09/MySql-mvcc/" class="post-title-link" itemprop="url">mvcc</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-09 15:14:20" itemprop="dateCreated datePublished" datetime="2023-04-09T15:14:20+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>MVCC 是一种多版本读写并发控制机制，是 InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现 READ COMMIITTED 和 REPEATABLE READ 这两种隔离级别</p>
<p>MVCC 通过保存数据在某个时间点的快照来实现的；每行数据都存在一个版本，对数据库的任何修改的提交都不会直接覆盖之前的数据，而是产生一个新的版本与老版本共存，使得读取时可以不加锁（除非使用 <code>SELECT ... FOR UPDATE</code> 强行加锁）</p>
<ul>
<li><p>通过 MVCC 可以让读写互相不阻塞，读不相互阻塞，写不阻塞读，这样可以提升数据并发处理能力</p>
</li>
<li><p>降低了死锁的概率，因为 MVCC 采用了乐观锁的方式，读取数据时，不需要加锁，写操作，只需要锁定必要的行</p>
</li>
<li><p>解决了一致性读的问题，MVCC 都是快照读，只能看到这个时间点之前事务提交更新的结果，不能看到时间点之后事务提交的更新结果</p>
</li>
</ul>
<h2 id="事务版本号"><a href="#事务版本号" class="headerlink" title="事务版本号"></a>事务版本号</h2><p>每次事务开启前都会从数据库获得一个自增长的事务 ID，可以从事务 ID 判断事务的执行先后顺序</p>
<h2 id="Undo-log"><a href="#Undo-log" class="headerlink" title="Undo log"></a>Undo log</h2><p>Undo log 主要用于记录数据被修改之前的日志，在表信息修改之前先会把数据拷贝到 Undo log 里，当事务进行回滚时可以通过 Undo log 里的日志进行数据还原</p>
<ul>
<li><p>保证事务进行 rollback 时的原子性和一致性，当事务进行回滚的时候可以用 Undo log 的数据进行恢复</p>
</li>
<li><p>通过读取 Undo log 的历史版本数据可以实现不同事务版本号都拥有自己独立的快照数据版本</p>
</li>
</ul>
<p>存储数据表的 B+ 树节点总是只保留最新的数据，而老版本的数据被放在 Undo log 里，并且以指针的形式关联起来，形成一个链表；查询时会在 B+ 树查找后多引入一个链表查询，但是清理废弃数据时会比较简单，只要把 Undo log 找到一个合适的位置一刀切了即可</p>
<h2 id="隐藏字段"><a href="#隐藏字段" class="headerlink" title="隐藏字段"></a>隐藏字段</h2><p>MySQL 会为每一行真实数据记录添加两三个隐藏的字段，分别为 row_id、transaction_id 和 roll_pointer</p>
<ul>
<li><p>row_id：非必需隐藏字段；如果表中有自定义的主键或者有 Unique 键，就不会添加 row_id 字段，如果两者都没有，MySQL 会自动添加 row_id 字段</p>
</li>
<li><p>transaction_id：必需隐藏字段；代表这一行数据由哪个事务 id 创建</p>
</li>
<li><p>roll_pointer：必需隐藏字段；回滚指针，指向这行数据上一个版本在 Undo log 的地址</p>
</li>
</ul>
<img src="/2023/04/09/MySql-mvcc/01.png" class="">

<p>对于事务 id，只有执行 insert&#x2F;update&#x2F;delete 才会产生事务 id，只执行 select 则没有事务 id</p>
<img src="/2023/04/09/MySql-mvcc/02.png" class="">

<h2 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h2><p>READ COMMITTED 和 REPEATABLE READ 这两个事务隔离级别都要保证读到的数据是其他事务已经提交的，但是还是有一定的区别，最核心的问题就在于到底可以读取这个数据的哪个版本</p>
<p>ReadView 机制只在 Read Committed 和 Repeatable Read 隔离级别下生效，所以只有这两种隔离级别才有 MVCC</p>
<h3 id="ReadView-组成"><a href="#ReadView-组成" class="headerlink" title="ReadView 组成"></a>ReadView 组成</h3><p>ReadView 包含四个比较重要的内容：</p>
<ul>
<li><p>m_ids：表示在生成 ReadView 时，系统中活跃的事务 id 集合</p>
</li>
<li><p>min_trx_id：表示在生成 ReadView 时，系统中活跃的最小事务 id，也就是 m_ids 中的最小值</p>
</li>
<li><p>max_trx_id：表示在生成 ReadView 时，系统应该分配给下一个事务的 id</p>
</li>
<li><p>creator_trx_id：表示生成该 ReadView 的事务 id</p>
</li>
</ul>
<h3 id="ReadView-用法"><a href="#ReadView-用法" class="headerlink" title="ReadView 用法"></a>ReadView 用法</h3><p>有了 ReadView，根据相关信息则可以判断版本信息：</p>
<ul>
<li><p>如果被访问的版本的 trx_id 和 ReadView 中的 creator_trx_id 相同，就意味着当前版本就是由当前事务创建的，可以读出来</p>
</li>
<li><p>如果被访问的版本的 trx_id 小于 ReadView 中的 min_trx_id，表示生成该版本的事务在创建 ReadView 的时候已经提交了，所以该版本可以读出来</p>
</li>
<li><p>如果被访问版本的 trx_id 大于或等于 ReadView 中的 max_trx_id 值，说明生成该版本的事务在当前事务生成 ReadView 后才开启，所以该版本不可以被读出来</p>
</li>
<li><p>如果生成被访问版本的 trx_id 在 min_trx_id 和 max_trx_id 之间，那就需要判断下 trx_id 在不在 m_ids 中；如果在，说明创建 ReadView 的时候，生成该版本的事务还是活跃的（没有被提交），该版本不可以被读出来；如果不在，说明创建 ReadView 的时候，生成该版本的事务已经被提交了，该版本可以被读出来</p>
</li>
<li><p>如果某个数据的最新版本不可以被读出来，就顺着 roll_pointer 找到该数据的上一个版本，继续做如上的判断</p>
</li>
</ul>
<h3 id="更新逻辑"><a href="#更新逻辑" class="headerlink" title="更新逻辑"></a>更新逻辑</h3><p>更新数据都是先读后写的，且只能读当前的值，称为当前读</p>
<p>除了 <code>update</code> 语句外，<code>select</code> 语句如果加锁，也是当前读</p>
<h3 id="READ-COMMITTED"><a href="#READ-COMMITTED" class="headerlink" title="READ COMMITTED"></a>READ COMMITTED</h3><p>每次读取数据都会创建 ReadView</p>
<h3 id="REPEATABLE-READ"><a href="#REPEATABLE-READ" class="headerlink" title="REPEATABLE READ"></a>REPEATABLE READ</h3><p>事务启动时创建 ReadView，整个事务期间都使用同一个 ReadView</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t` ( </span><br><span class="line">    `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line">    `k` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, </span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">    ) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t(id, k) <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<img src="/2023/04/09/MySql-mvcc/03.png" class="">

<h3 id="事务启动时机"><a href="#事务启动时机" class="headerlink" title="事务启动时机"></a>事务启动时机</h3><p><code>begin/start transaction</code> 命令并不是一个事务的起点，在执行到它们之后的第一个操作 InnoDB 表的语句，事务才真正启动</p>
<p>如果想要马上启动一个事务，可以使用 <code>start transaction with consistent snapshot</code> 这个命令</p>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>事务 C 没有显式地使用 <code>begin/commit</code>，表示这个 <code>update</code> 语句本身就是一个事务，语句完成的时候会自动提交</p>
<p>事务 B 在更新了行之后查询</p>
<p>事务 A 在一个只读事务中查询，并且时间顺序上是在事务 B 的查询之后</p>
<p>事务 B 查到的 k 的值是 3，而事务 A 查到的 k 的值是 1</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>做如下假设：</p>
<ul>
<li><p>事务 A 开始前，系统里面只有一个活跃事务 ID 是 99</p>
</li>
<li><p>事务 A、B、C 的版本号分别是 100、101、102，且当前系统里只有这四个事务</p>
</li>
<li><p>三个事务开始前，(1,1）这一行数据的 transaction_id 是 90</p>
</li>
</ul>
<p>事务 A 的 m_ids 是[99,100]，事务 B 的 m_ids 是[99,100,101], 事务 C 的 m_ids 是[99,100,101,102]</p>
<img src="/2023/04/09/MySql-mvcc/04.png" class="">

<p>第一个有效更新是事务 C，把数据从 (1,1) 改成了 (1,2)。这时候这个数据的最新版本的 transaction_id 是 102，而 90 这个版本已经成为了历史版本</p>
<p>第二个有效更新是事务 B，把数据从 (1,2) 改成了 (1,3)。这时候这个数据的最新版本 transaction_id 是 101，而 102 又成为了历史版本</p>
<p>事务 A 读数据时，它的 m_ids 是 [99,100]，它的读数据流程：</p>
<ol>
<li><p>找到 (1,3) 的时候，判断出 transaction_id &#x3D; 101，比 100 大，不可见</p>
</li>
<li><p>接着，找到上一个历史版本，transaction_id &#x3D; 102，比 100 大，不可见</p>
</li>
<li><p>接着，找到上一个历史版本，一看 transaction_id &#x3D; 90，比99小，可见</p>
</li>
</ol>
<p>当事务 B 要去更新数据的时候，就不能再在历史版本上更新了，否则事务 C 的更新就丢失了，因此，事务 B 此时的 <code>set k=k+1</code> 是在（1,2）的基础上进行的操作</p>
<p>在更新的时候，当前读拿到的数据是 (1,2)，更新后生成了新版本的数据 (1,3)，这个新版本的 transaction_id 是 101；在执行事务 B 查询语句的时候，一看自己的版本号是 101 和最新数据的版本号相同，可以直接使用，所以查询得到的 k 的值是 3</p>
<p>如果把事务 A 的查询语句 select * from t where id&#x3D;1 修改一下，加上 lock in share mode 或 for update，也都可以读到版本号是 101 的数据，返回的 k 的值是 3</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>假设事务 C 不是马上提交的，而是变成了下面的事务 C’</p>
<img src="/2023/04/09/MySql-mvcc/05.png" class="">

<p>事务 C’ 的不同是，更新后并没有马上提交，在它提交前，事务 B 的更新语句先发起了</p>
<p>虽然事务 C’ 还没提交，但是 (1,2) 这个版本也已经生成了，并且是当前的最新版本</p>
<p>事务 C’ 没提交，也就是说 (1,2) 这个版本上的写锁还没释放。而事务 B 是当前读，必须要读最新版本，而且必须加锁，因此就被锁住了，必须等到事务 C’ 释放这个锁，才能继续它的当前读</p>
<img src="/2023/04/09/MySql-mvcc/06.png" class="">
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/09/MySql-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/09/MySql-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">日志系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-09 15:12:20" itemprop="dateCreated datePublished" datetime="2023-04-09T15:12:20+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>更新流程涉及两个重要的日志模块：redo log（重做日志）和 binlog（归档日志）</p>
<p>redo log 是 InnoDB 引擎特有的日志，Server 层的日志称为 binlog</p>
<h2 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h2><p>当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到 redo log，并更新内存，这个时候更新就算完成了</p>
<p>InnoDB 引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做</p>
<p>InnoDB 的 redo log 是固定大小的，比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么redo log 总共就可以记录 4GB 的操作，从头开始写，写到末尾就又回到开头循环写</p>
<img src="/2023/04/09/MySql-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/01.png" class="">

<p>write pos 是当前记录的位置，一边写一边后移；checkpoint 是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件</p>
<p>write pos 和 checkpoint 之间的部分是可以用来记录新的操作；如果 write pos 追上 checkpoint，这时候不能再执行新的更新，需要把 checkpoint 推进一下</p>
<p>有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失</p>
<p>redo log 的写入拆成了两个步骤：prepare 和 commit，这就是两阶段提交，是为了让 redo log 和 binlog 之间的逻辑一致</p>
<p>由于 redo log 和 binlog 是两个独立的逻辑，如果不用两阶段提交，会出现一定问题</p>
<h2 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h2><p>与 redo log 区别：</p>
<ol>
<li><p>redo log 是 InnoDB 引擎特有的；binlog 是 MySQL 的 Server 层实现的，所有引擎都可以使用</p>
</li>
<li><p>redo log 是物理日志，记录的是在某个数据页上做了什么修改；binlog 是逻辑日志，记录的是这个语句的原始逻辑</p>
</li>
<li><p>redo log 是循环写的，空间固定会用完；binlog 是可以追加写入的</p>
</li>
</ol>
<p>对于 SQL 语句 <code>update T set c=c+1 where ID=2</code>：</p>
<ol>
<li><p>执行器先找引擎取 <code>ID=2</code> 这一行</p>
</li>
<li><p>如果 <code>ID=2</code> 这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回</p>
</li>
<li><p>执行器拿到引擎给的行数据，把这个值加上 1，再调用引擎接口写入这行新数据</p>
</li>
<li><p>引擎将这行新数据更新到内存中，同时将这个更新操作记录到 redo log 里面，然后告知执行器执行完成，此时 redo log 处于 prepare 状态</p>
</li>
<li><p>执行器生成这个操作的 binlog，并把 binlog 写入磁盘</p>
</li>
<li><p>执行器调用引擎的提交事务接口，引擎把刚刚写入的 redo log 改成提交（commit）状态，更新完成</p>
</li>
</ol>
<img src="/2023/04/09/MySql-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/01.jpg" class="">

<p>MySQL 以 binlog 的写入与否作为事务是否成功的标记</p>
<h2 id="奔溃恢复规则"><a href="#奔溃恢复规则" class="headerlink" title="奔溃恢复规则"></a>奔溃恢复规则</h2><p>redo log 和 binlog 有一个共同的数据字段，叫 XID</p>
<p>崩溃恢复的时候，会按顺序扫描 redo log：</p>
<ol>
<li><p>如果碰到既有 prepare、又有 commit 的 redo log，就直接提交</p>
</li>
<li><p>如果碰到只有 parepare、而没有 commit 的 redo log，就拿着 XID 去 binlog 找对应的事务；binlog 无记录，回滚事务；binlog 有记录，提交事务</p>
</li>
</ol>
<p>先写 redo log 后写 binlog：假设在 redo log 写完，binlog 还没有写完的时候，MySQL 进程异常重启；由于 bin log 日志没有修改记录，使用 redo log + bin log 恢复的数据就是数据库旧的数据</p>
<p>先写 bin log 后写 redo log：假设在 bin log 写完，redo log 还没有完成的时候，MySQL 进程异常重启</p>
<p>binlog 写入后会被从库（或者用这个 binlog 恢复出来的库）使用，保证主库和备库的数据就一致性</p>
<h2 id="binlog-完整性"><a href="#binlog-完整性" class="headerlink" title="binlog 完整性"></a>binlog 完整性</h2><p>MySQL 引入 binlog-checksum 参数，用来验证 binlog 内容的正确性</p>
<h2 id="binlog-相比-redo-log-优越性"><a href="#binlog-相比-redo-log-优越性" class="headerlink" title="binlog 相比 redo log 优越性"></a>binlog 相比 redo log 优越性</h2><ol>
<li><p>redo log 是循环写，写到末尾是要回到开头继续写的，这样历史日志没法保留，redo log 也就起不到归档的作用</p>
</li>
<li><p>MySQL 系统依赖于 binlog，系统高可用的基础，就是 binlog 复制</p>
</li>
</ol>
<h2 id="redo-log-buffer"><a href="#redo-log-buffer" class="headerlink" title="redo log buffer"></a>redo log buffer</h2><p>redo log buffer 就是一块内存，用来先存 redo 日志的</p>
<p>真正把日志写到 redo log 文件，是在执行 commit 语句的时候做的</p>
<p>事务执行过程中不会主动去刷盘，以减少不必要的 IO 消耗，但是可能会出现被动写入磁盘，比如内存不够、其他事务提交等情况</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/09/MySql-%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/09/MySql-%E9%94%81/" class="post-title-link" itemprop="url">锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-09 15:10:29" itemprop="dateCreated datePublished" datetime="2023-04-09T15:10:29+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表级锁和行锁三类</p>
<h2 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h2><p>全局锁就是对整个数据库实例加锁，MySQL 提供了一个加全局读锁的方法，命令是 Flush tables with read lock，让整个库处于只读状态，修改表的线程全部阻塞</p>
<p>全局锁的典型使用场景是，做全库逻辑备份，也就是把整库每个表都 select 出来存成文本</p>
<p>让整个库只可读，有一些隐患：</p>
<ul>
<li><p>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆</p>
</li>
<li><p>如果在从库上备份，那么备份期间从库不能执行主库同步过来的 binlog，会导致主从延迟</p>
</li>
</ul>
<h2 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h2><p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁 MDL</p>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><p>表锁的语法是 lock tables … read&#x2F;write，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放</p>
<p>lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象</p>
<h3 id="MDL"><a href="#MDL" class="headerlink" title="MDL"></a>MDL</h3><p>MDL(meta data lock) 不需要显式使用，在访问一个表的时候会被自动加上</p>
<p>MDL 的作用是，保证读写的正确性；如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的</p>
<p>当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁</p>
<ul>
<li><p>读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查</p>
</li>
<li><p>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性</p>
</li>
</ul>
<p>申请 MDL 锁的操作会形成一个队列，队列中写锁获取优先级高于读锁；一旦出现写锁等待，不但当前操作会被阻塞，同时还会阻塞后续该表的所有操作</p>
<p>事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放</p>
<h2 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h2><p>行锁就是针对数据表中行记录的锁</p>
<p>两阶段锁协议：InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放</p>
<p>尽量将并发度高的行，放在事务的最后进行执行</p>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态</p>
<p>InnoDB 能检测到死锁的循环依赖并立即返回一个错误，主动死锁检测在发生死锁的时候，是能够快速发现并进行处理的，但是它也是有额外负担的；每当一个事务被锁的时候，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待，也就是死锁；每个新来的被堵住的线程，都要判断会不会由于自己的加入导致了死锁，这是一个时间复杂度是 O(n) 的操作</p>
<p>解决方法：</p>
<ul>
<li><p>尽量使用较低的隔离级别</p>
</li>
<li><p>设计索引，并尽量使用索引访问数据，使加锁更精确，从而减少锁冲突的机会</p>
</li>
<li><p>显示加锁时，一次性请求足够级别的锁</p>
</li>
<li><p>如果不同程序会并发存取多个表，尽量约定以相同的顺序访问表</p>
</li>
<li><p>尽量用相等条件访问数据</p>
</li>
<li><p>在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁产生概率</p>
</li>
<li><p>对于非常容易产生死锁的业务部分，可以尝试使用升级锁定颗粒度，通过表级锁定来减少死锁产生的概率</p>
</li>
<li><p>用分布式事务锁或者使用乐观锁</p>
</li>
</ul>
<h2 id="InnoDB-的行锁与表锁"><a href="#InnoDB-的行锁与表锁" class="headerlink" title="InnoDB 的行锁与表锁"></a>InnoDB 的行锁与表锁</h2><p>InnoDB 行锁是通过给索引上的索引项加锁来实现的；只有通过索引条件检索数据，InnoDB 才使用行级锁，否则将使用表锁</p>
<p>由于 MySQL 的行锁是针对索引加的锁，不是针对记录加的锁，因此虽然是访问不同行的记录，但是如果是使用相同的索引键，是会出现锁冲突的(查询非唯一索引时，非唯一索引可能对应多条聚簇索引，因此会锁住多行)；当表有多个索引的时候，不同的事务可以使用不同的索引锁定不同的行</p>
<p>即便在条件中使用了索引字段，但是否使用索引来检索数据是由 MySQL 通过判断不同的执行计划的代价来决定的。如果 MySQL 认为全表扫描效率更高，比如对一些很小的表，它就不会使用索引，这种情况下 InnoDB 将使用表锁，而不是行锁</p>
<h2 id="InnoDB-锁算法"><a href="#InnoDB-锁算法" class="headerlink" title="InnoDB 锁算法"></a>InnoDB 锁算法</h2><h3 id="Record-lock"><a href="#Record-lock" class="headerlink" title="Record lock"></a>Record lock</h3><p>单个行记录上的锁；当查询的索引含有唯一属性时，使用 record lock；RC 级别使用该方式加锁</p>
<ul>
<li>使用聚簇索引等值查询</li>
</ul>
<img src="/2023/04/09/MySql-%E9%94%81/01.png" class="">

<ul>
<li>使用唯一索引等值查询</li>
</ul>
<img src="/2023/04/09/MySql-%E9%94%81/02.png" class="">

<h3 id="Gap-lock"><a href="#Gap-lock" class="headerlink" title="Gap lock"></a>Gap lock</h3><p>间隙锁，锁定一个索引范围（左开右开），不包括记录本身；设计的目的是为了阻止多个事务将记录插入到同一范围内，防止幻读的产生</p>
<ul>
<li>使用一般索引等值查询：不仅给相应索引和聚簇索引加 record lock，还要给索引间隙加 gap lock</li>
</ul>
<img src="/2023/04/09/MySql-%E9%94%81/03.png" class="">

<img src="/2023/04/09/MySql-%E9%94%81/04.png" class="">

<ul>
<li>无索引查询：将聚簇索引中的所有行以及间隙都锁起来，等于锁表了</li>
</ul>
<img src="/2023/04/09/MySql-%E9%94%81/05.png" class="">

<h3 id="Next-key-lock"><a href="#Next-key-lock" class="headerlink" title="Next-key lock"></a>Next-key lock</h3><p>record+gap 锁定一个范围，并包含记录本身；对于行的查询使用 next-key lock，解决幻读问题；把查询出来的记录锁住，同时也会把该范围查询内的所有间隙空间也会锁住，再之它会把相邻的下一个区间也会锁住；当使用唯一索引且得到的结果只有 1 条则降级为 Record lock；RR 级别使用该方式加锁</p>
<img src="/2023/04/09/MySql-%E9%94%81/06.png" class="">

<h2 id="锁机制划分"><a href="#锁机制划分" class="headerlink" title="锁机制划分"></a>锁机制划分</h2><p>三种锁都分为共享读锁和排他写锁</p>
<h3 id="共享读锁"><a href="#共享读锁" class="headerlink" title="共享读锁"></a>共享读锁</h3><ul>
<li><p>持有读锁的会话可以读表，但不能写表</p>
</li>
<li><p>允许多个会话同时持有读锁</p>
</li>
<li><p>其他会话就算没有给表加读锁，也是可以读表的，但是不能写表</p>
</li>
<li><p>其他会话申请该表写锁时会阻塞，直到锁释放</p>
</li>
</ul>
<h3 id="排他写锁"><a href="#排他写锁" class="headerlink" title="排他写锁"></a>排他写锁</h3><ul>
<li><p>持有写锁的会话既可以读表，也可以写表</p>
</li>
<li><p>只有持有写锁的会话才可以访问该表，其他会话访问该表会被阻塞，直到锁释放</p>
</li>
<li><p>其他会话无论申请该表的读锁或写锁，都会阻塞，直到锁释放</p>
</li>
</ul>
<h2 id="隔离级别与锁"><a href="#隔离级别与锁" class="headerlink" title="隔离级别与锁"></a>隔离级别与锁</h2><ul>
<li><p>未提交读 READ UNCOMMITTED：读取数据不加共享锁</p>
</li>
<li><p>提交读 READ COMMITTED：读取数据加共享锁，操作结束后释放共享锁</p>
</li>
<li><p>可重复读 REPEATABLE READ：读取数据加共享锁，事务提交前不释放锁</p>
</li>
<li><p>可串行化 SERIALIZABLE：锁定整个范围的键并一直有锁，直到事务完成</p>
</li>
</ul>
<h2 id="乐观锁、悲观锁"><a href="#乐观锁、悲观锁" class="headerlink" title="乐观锁、悲观锁"></a>乐观锁、悲观锁</h2><ul>
<li><p>乐观锁：假设不会发生并发冲突不会上锁，只在提交操作时检查是否违反数据完整性；适用于多读的应用类型，这样可以提高吞吐量</p>
</li>
<li><p>悲观锁：假定会发生并发冲突，每次在拿数据的时候都会上锁，屏蔽一切可能违反数据完整性的操作；</p>
</li>
</ul>
<h2 id="死锁-1"><a href="#死锁-1" class="headerlink" title="死锁"></a>死锁</h2><p>当多个进程访问同一数据库时，其中每个进程拥有的锁都是其他进程所需的，由此造成每个进程都无法继续下去；进程 A 等待进程 B 释放他的资源，B 又等待 A 释放他的资源，这样就互相等待就形成死锁</p>
<h2 id="表锁行锁与死锁"><a href="#表锁行锁与死锁" class="headerlink" title="表锁行锁与死锁"></a>表锁行锁与死锁</h2><p>MyISAM 中是不会产生死锁的，因为 MyISAM 总是一次性获得所需的全部锁，要么全部满足，要么全部等待。而在 InnoDB 中，锁是逐步获得的，就造成了死锁的可能</p>
<p>InnoDB 行锁并不是直接锁数据而是锁索引；索引分为主键索引和非主键索引两种，如果一条 SQL 语句操作了主键索引，MySQL 就会锁定这条主键索引；如果一条 SQL 语句操作了非主键索引，MySQL 就会先锁定该非主键索引，再锁定相关的主键索引</p>
<p>当两个事务同时执行，一个锁住了主键索引，在等待其他相关索引；另一个锁定了非主键索引，在等待主键索引，这样就会发生死锁</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/04/09/MySql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/09/MySql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/" class="post-title-link" itemprop="url">事务隔离</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-09 15:09:39" itemprop="dateCreated datePublished" datetime="2023-04-09T15:09:39+08:00">2023-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-21 12:04:19" itemprop="dateModified" datetime="2023-09-21T12:04:19+08:00">2023-09-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>事务是一个不可分割的数据库操作序列，要么完全地执行，要么完全地不执行，是数据库并发控制得基本单位</p>
<p>通过将一组相关操作组合为一个要么全部成功要么全部失败的单元，可以简化错误恢复并使应用程序更加可靠</p>
<p>一个逻辑工作单元要成为事务，必须满足所谓的 ACID 属性</p>
<ul>
<li><p>原子性（Atomicity）：原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚</p>
</li>
<li><p>一致性（Consistency）：一致性规定了事务提交前后，永远只可能存在事务提交前的状态和事务提交后的状态，从一个一致性的状态到另一个一致性状态，而不可能出现中间的过程态；事务的执行结果是量子化状态，而不是线性状态</p>
</li>
<li><p>隔离性（Isolation）：当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务不能被其他事务的操作所干扰，多个并发事务之间要相互隔离；多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果；当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间</p>
</li>
<li><p>持久性（Durability）：持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作</p>
</li>
</ul>
<p>在 MySQL 中，事务支持是在引擎层实现的</p>
<h2 id="数据库并发操作带来的一致性问题"><a href="#数据库并发操作带来的一致性问题" class="headerlink" title="数据库并发操作带来的一致性问题"></a>数据库并发操作带来的一致性问题</h2><p>数据库事物无非两种：读取事物、修改事物</p>
<p>在没有事务隔离控制的时候，多个事务在同一时刻对同一数据的操作可能就会影响到最终期望的结果，通常有四种情况：</p>
<ul>
<li><p>脏写：一个事务的更新覆盖了另一个事务还没提交的更新（事务 A和 B 读入同一数据并修改，B 提交的结果破坏了 A 提交的结果，导致 A 的修改被丢失）</p>
</li>
<li><p>脏读：一个事务读取了另一个事物未提交的数据（事务 A 修改某一数据，并将其写回磁盘，事务 B 读取同一数据后，A 由于某种原因被撤销，这时 A 已修改过的数据恢复原值，B 读到的数据就与数据库中的数据不一致，则 B 读到的数据为脏数据）</p>
</li>
<li><p>不可重复读：一个事务两次读取同一个数据，两次读取的数据不一致（事务 A 读取某一数据后，事务 B 对其作了修改，当事务 A 再次读取数据时，得到与前一次不同的值；事务 A 按一定的条件从数据库中读取了某些数据后，事务 B 删除了其中部分记录，当 A 再次以相同条件读取时，发现某些记录消失了）</p>
</li>
<li><p>幻读：一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据</p>
</li>
</ul>
<p>幻读和不可重复读都是读取了另一条已经提交的事务（这点和脏读不同），所不同的是不可重复读查询的都是同一个数据项，而幻读针对的是一批数据整体</p>
<h2 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h2><p>同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰</p>
<ul>
<li><p>未提交读 READ UNCOMMITTED：最低的隔离级别，一个事务在提交之前，对其他事务是可见的，即事务可以读取未提交的数据；存在脏读（读到了脏数据）问题</p>
</li>
<li><p>提交读 READ COMMITTED：事务在提交之前，对其它事务是不可见的；解决了脏读的问题，但存在不可重复读（两次查询的得到的结果可能不同，即可能在查询的间隙，有事务提交了修改）问题</p>
</li>
<li><p>可重复读 REPEATABLE READ：默认隔离等级，在同一事务中多次读取的数据是一致的；解决了脏读和不可重复读问题，存在幻读（在事务两次查询间隙，有其他事务又插入或删除了新的记录）问题</p>
</li>
<li><p>可串行化 SERIALIZABLE：通过对每个读的数据行加上共享锁，强制事务串行化执行，即一个事务一个事务挨个来执行，可以解决上述所有问题，隔离级别最高，牺牲了系统的并发性；可以解决并发事务的所有问题</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/29/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><span class="page-number current">30</span><a class="page-number" href="/page/31/">31</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/31/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaxxro</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
