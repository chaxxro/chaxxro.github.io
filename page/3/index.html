<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chaxxro.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="好记性不如烂键盘">
<meta property="og:type" content="website">
<meta property="og:title" content="也无风雨也无晴">
<meta property="og:url" content="https://chaxxro.github.io/page/3/index.html">
<meta property="og:site_name" content="也无风雨也无晴">
<meta property="og:description" content="好记性不如烂键盘">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="chaxxro">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://chaxxro.github.io/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>也无风雨也无晴</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">也无风雨也无晴</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaxxro</p>
  <div class="site-description" itemprop="description">好记性不如烂键盘</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">411</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/26/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-ldd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/26/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-ldd/" class="post-title-link" itemprop="url">ldd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-26 16:46:54" itemprop="dateCreated datePublished" datetime="2023-12-26T16:46:54+08:00">2023-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-%E5%91%BD%E4%BB%A4%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">Linux 命令行</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>打印依赖的动态库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ldd [option]... file...</span><br><span class="line"></span><br><span class="line">-v 打印所有信息</span><br><span class="line">-u 打印不直接依赖的库</span><br></pre></td></tr></table></figure>

<p>在比较老的 glibc 版本（2.2 或更早），ldd 可能会显示一个目录下的动态库，但是真正运行时可能链接另一个目录的动态库。该问题在 glibc 2.3.2 版本上修复了</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-Linux%E9%87%8D%E8%A6%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-Linux%E9%87%8D%E8%A6%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" class="post-title-link" itemprop="url">post</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-26 16:43:02" itemprop="dateCreated datePublished" datetime="2023-12-26T16:43:02+08:00">2023-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" itemprop="url" rel="index"><span itemprop="name">Linux环境变量</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="PWD"><a href="#PWD" class="headerlink" title="PWD"></a>PWD</h2><p>当前地址</p>
<h2 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h2><p>动态链接库在加载过程中，动态链接器会先读取 <code>LD_PRELOAD</code> 环境变量和默认配置文件 &#x2F;etc&#x2F;ld.so.preload，即使程序不依赖这些动态链接库，<code>LD_PRELOAD</code> 环境变量和 &#x2F;etc&#x2F;ld.so.preload 配置文件中指定的动态链接库依然会被加载，因为它们的优先级比 <code>LD_LIBRARY_PATH</code> 环境变量所定义的链接库查找路径的文件优先级要高，所以能够提前于用户调用的动态库载入</p>
<p>LD_PRELOAD &gt; LD_LIBRARY_PATH &gt; &#x2F;etc&#x2F;ld.so.cache &gt; &#x2F;lib &gt; &#x2F;usr&#x2F;lib</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_PRELOAD=<span class="variable">$PWD</span>/xx.so</span><br><span class="line"><span class="comment"># 可以从 ldd 中查看是否生效</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> -n LD_PRELOAD=<span class="variable">$PWD</span>/xx.so <span class="comment"># 删除</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/25/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-strace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/25/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-strace/" class="post-title-link" itemprop="url">post</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-25 21:44:04" itemprop="dateCreated datePublished" datetime="2023-12-25T21:44:04+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-%E5%91%BD%E4%BB%A4%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">Linux 命令行</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>跟踪进程系统调用和解决库依赖问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">strace [-ACdffhikqqrtttTvVwxxyyzZ] [-I n] [-b execve] [-e <span class="built_in">expr</span>]... [-O overhead] [-S sortby] [-U columns] [-a column] [-o file] [-s strsize]</span><br><span class="line">              [-X format] [-P path]... [-p pid]... [--seccomp-bpf] &#123; -p pid | [-DDD] [-E var[=val]]... [-u username] <span class="built_in">command</span> [args] &#125;</span><br><span class="line"></span><br><span class="line">-c 统计每一系统调用的所执行的时间、次数和出错的次数等</span><br><span class="line">-d 输出 strace 本身的标准错误调试信息</span><br><span class="line">-f 跟踪由 fork 调用所产生的子进程</span><br><span class="line">--output-separately 多个进程的 strace 分开输出</span><br><span class="line">-ff 等同于 -f + --output-separately</span><br><span class="line">-i 输出系统调用的入口指针</span><br><span class="line">-t 在输出中的每一行前加上时间信息</span><br><span class="line">-tt 在输出中的每一行前加上微秒级时间信息</span><br><span class="line">-T 显示每一调用所耗的时间</span><br><span class="line">-v 输出所有的系统调用</span><br><span class="line">-x 以十六进制形式输出非标准字符串</span><br><span class="line">-xx 所有字符串以十六进制形式输出</span><br><span class="line"></span><br><span class="line">-e <span class="built_in">expr</span> 指定一个表达式，用来控制如何跟踪.格式如下 [qualifier=][!]value1[,value2]...</span><br><span class="line">qualifier 只能是 trace、abbrev、verboseraw、signal、<span class="built_in">read</span>、write，默认是 trace</span><br><span class="line">value 是用来限定的符号或数字，有两个特殊的符号 all 和 none</span><br><span class="line">感叹号是否定符号</span><br><span class="line">-eopen 等价于 -e trace=open，表示只跟踪 open 调用，-e trace!=open表示跟踪除了 open 以外的其他调用</span><br><span class="line">-e trace=open,close,rean,write 表示只跟踪这四个系统调用</span><br><span class="line">-e trace=file 只跟踪有关文件操作的系统调用</span><br><span class="line">-e trace=process 只跟踪有关进程控制的系统调用</span><br><span class="line">-e trace=network 跟踪与网络有关的所有系统调用</span><br><span class="line">-e strace=signal 跟踪所有与系统信号有关的系统调用</span><br><span class="line">-e trace=ipc 跟踪所有与进程通讯有关的系统调用</span><br><span class="line">-e abbrev=<span class="built_in">set</span> 设定 strace 输出的系统调用的结果集，-v 等于 abbrev=none，默认为abbrev=all</span><br><span class="line">-e raw=<span class="built_in">set</span> 将指定的系统调用的参数以十六进制显示</span><br><span class="line">-e signal=<span class="built_in">set</span> 指定跟踪的系统信号，默认为 all，如 signal=!SIGIO</span><br><span class="line">-e <span class="built_in">read</span>=<span class="built_in">set</span> 输入从指定文件中读取，如 -e <span class="built_in">read</span>=3,5</span><br><span class="line">-e write=<span class="built_in">set</span> 输出写入到指定文件中</span><br><span class="line"></span><br><span class="line">-o filename 将strace的输出写入文件</span><br><span class="line">-p pid 跟踪指定的进程pid</span><br><span class="line">-u username 以 username 的 UID 和 GID 执行被跟踪的命令</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/25/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-pstree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/25/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-pstree/" class="post-title-link" itemprop="url">pstree</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-25 21:27:10" itemprop="dateCreated datePublished" datetime="2023-12-25T21:27:10+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-%E5%91%BD%E4%BB%A4%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">Linux 命令行</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用树状形式显示所有进程之间的关系</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> pstree [-a, --arguments] [-c, --compact] [-h, --highlight-all, -Hpid, --highlight-pid pid] [-g] --show-pgids] [-l, --long] [-n, --numeric-sort]</span><br><span class="line">       [-N, --ns-sortns [-p, --show-pids] [-s, --show-parents] [-S, --ns-changes] [-t, --thread-names] [-T, --hide-threads] [-u, --uid-changes] [-Z, --secu‐</span><br><span class="line">       rity-context] [-A, --ascii, -G, --vt100, -U, --unicode] [pid, user]</span><br><span class="line"></span><br><span class="line">-a：显示所有进程的命令行参数</span><br><span class="line">-c：显示进程的真实名称，而不是简短的命令名称</span><br><span class="line">-h：高亮当前进程和父进程</span><br><span class="line">-l：显示进程的完整命令行参数</span><br><span class="line">-n：按 pid 排序</span><br><span class="line">-s：显示进程的父进程</span><br><span class="line">-p：指定 pid</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/21/LinuxApi-truncate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/21/LinuxApi-truncate/" class="post-title-link" itemprop="url">truncate</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-21 11:01:59" itemprop="dateCreated datePublished" datetime="2023-12-21T11:01:59+08:00">2023-12-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LinuxApi/" itemprop="url" rel="index"><span itemprop="name">LinuxApi</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>将文件设置为指定的大小</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">truncate</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">off_t</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ftruncate</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> length)</span></span>;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/15/cpp%E7%BB%86%E8%8A%82-shared-ptr%E7%9B%B8%E5%85%B3%E7%BB%86%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/15/cpp%E7%BB%86%E8%8A%82-shared-ptr%E7%9B%B8%E5%85%B3%E7%BB%86%E8%8A%82/" class="post-title-link" itemprop="url">shared_ptr相关细节</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-15 10:25:55" itemprop="dateCreated datePublished" datetime="2023-12-15T10:25:55+08:00">2023-12-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="优先使用-make-shared"><a href="#优先使用-make-shared" class="headerlink" title="优先使用 make_shared"></a>优先使用 make_shared</h2><p>直接构造 <code>shared_ptr</code> 需要先 <code>new</code> 相应的对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> Y &gt; </span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">shared_ptr</span><span class="params">( Y* ptr )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> Y, <span class="keyword">class</span> Deleter &gt; </span></span><br><span class="line"><span class="function"><span class="title">shared_ptr</span><span class="params">( Y* ptr, Deleter d )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> Y, <span class="keyword">class</span> Deleter, <span class="keyword">class</span> Alloc &gt; </span></span><br><span class="line"><span class="function"><span class="title">shared_ptr</span><span class="params">( Y* ptr, Deleter d, Alloc alloc )</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>std::make_shared</code> 函数模板</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// since c++11</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T, <span class="keyword">class</span>... Args &gt;</span></span><br><span class="line"><span class="function">shared_ptr&lt;T&gt; <span class="title">make_shared</span><span class="params">( Args&amp;&amp;... args )</span></span>;</span><br><span class="line"><span class="comment">// since c++20</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;</span></span><br><span class="line"><span class="function">shared_ptr&lt;T&gt; <span class="title">make_shared</span><span class="params">( std::<span class="type">size_t</span> N )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;</span></span><br><span class="line"><span class="function">shared_ptr&lt;T&gt; <span class="title">make_shared</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;</span></span><br><span class="line"><span class="function">shared_ptr&lt;T&gt; <span class="title">make_shared</span><span class="params">( std::<span class="type">size_t</span> N, <span class="type">const</span> std::<span class="type">remove_extent_t</span>&lt;T&gt;&amp; u )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;</span></span><br><span class="line"><span class="function">shared_ptr&lt;T&gt; <span class="title">make_shared</span><span class="params">( <span class="type">const</span> std::<span class="type">remove_extent_t</span>&lt;T&gt;&amp; u )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> sp0 = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>[<span class="number">5</span>]&gt;();</span><br><span class="line"><span class="keyword">auto</span> sp1 = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>[]&gt;(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<h3 id="std-make-shared-异常安全，发生异常时仍释放资源"><a href="#std-make-shared-异常安全，发生异常时仍释放资源" class="headerlink" title="std::make_shared 异常安全，发生异常时仍释放资源"></a><code>std::make_shared</code> 异常安全，发生异常时仍释放资源</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(std::shared_ptr&lt;Foo&gt;, <span class="type">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设函数形参 value 是调用另一个函数 get_value 获得的</span></span><br><span class="line"><span class="comment">// 直接构造 std::shared_ptr</span></span><br><span class="line"><span class="built_in">func</span>(std::<span class="built_in">shared_ptr</span>&lt;Foo&gt;(<span class="keyword">new</span> Foo), <span class="built_in">get_value</span>())</span><br><span class="line"><span class="comment">// 使用 std::make_shared 构造 std::shared_ptr</span></span><br><span class="line"><span class="built_in">func</span>(std::<span class="built_in">make_shared</span>&lt;Foo&gt;(), <span class="built_in">get_value</span>())</span><br></pre></td></tr></table></figure>

<p>当直接构造 <code>std::shared_ptr</code> 时，需要完成三个步骤</p>
<ol>
<li><p><code>new Foo</code></p>
</li>
<li><p><code>std::shared_ptr&lt;Foo&gt;()</code></p>
</li>
<li><p><code>get_value()</code></p>
</li>
</ol>
<p>但编译器不保证执行这三个步骤的顺序，所以当执行顺序是 1-&gt; 3 -&gt; 2 且 <code>get_value()</code> 抛出异常时，第一步已经成功初始化的资源便无法回收导致泄漏</p>
<p>使用 <code>std::make_shared</code> 时，需要完成两个步骤</p>
<ol>
<li><p><code>get_value</code></p>
</li>
<li><p><code>std::make_shared&lt;Foo&gt;()</code></p>
</li>
</ol>
<p>编译器不保证执行这两个步骤的顺序，所以当 <code>get_value</code> 发生异常时不会影响 <code>std::make_shared</code>，所以使用 <code>std::make_shared</code> 是异常安全的</p>
<h3 id="std-make-shared-比起直接使用-new-效率更高"><a href="#std-make-shared-比起直接使用-new-效率更高" class="headerlink" title="std::make_shared 比起直接使用 new 效率更高"></a><code>std::make_shared</code> 比起直接使用 <code>new</code> 效率更高</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">shared_ptr</span> : <span class="keyword">public</span> __shared_ptr&lt;_Tp&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shared_ptr_base.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, _Lock_policy _Lp&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">__shared_ptr</span> : <span class="keyword">public</span> __shared_ptr_access&lt;_Tp, _Lp&gt;&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> element_type = <span class="keyword">typename</span> remove_extent&lt;_Tp&gt;::type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  element_type* _M_ptr;</span><br><span class="line">  __shared_cout&lt;_Lp&gt; _M_refcount;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shared_ptr_base.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;_Lock_policy _Lp&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">__shared_count</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  _Sp_counted_base&lt;_Lp&gt;* _M_pi;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shared_ptr_base.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line"><span class="keyword">class</span> _Sp_counted_base : <span class="keyword">public</span> _Mutex_base&lt;_Lp&gt; &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  _Atomic_word _M_use_count;</span><br><span class="line">  _Atomic_word _M_weak_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看出，<code>shared_ptr</code> 内部有两块资源，分别是原始资源 <code>element_type* _M_ptr</code> 和控制块 <code>_Sp_counted_base _M_pi</code></p>
<p>直接调用构造函数时，需要先创建原始资源，再创建控制块，即需要通过两次 <code>new</code> 创建资源</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr.h</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> shared_ptr&lt;_Tp&gt; <span class="title">allocate_shared</span><span class="params">(<span class="type">const</span> _Alloc&amp; __a,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       _Args&amp;&amp;... __args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Tp&gt;(_Sp_alloc_shared_tag&lt;_Alloc&gt;&#123;__a&#125;,</span><br><span class="line">                          std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shared_ptr.h</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span>... _Args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> shared_ptr&lt;_Tp&gt; <span class="title">make_shared</span><span class="params">(_Args... __args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> std::remove_cv&lt;_Tp&gt;::type _Tp_nc;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">allocate_shared</span>&lt;_Tp&gt;(std::<span class="built_in">allocator</span>&lt;_Tp_nc&gt;(),</span><br><span class="line">                                     std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>从源码中可以看到 <code>std::make_shared</code> 调用的是 <code>std::shared_ptr</code> 私有构造函数 <code>shared_ptr(_Sp_alloc_shared_tag&lt;_Alloc&gt; __tag, _Args&amp;&amp;... __args)</code>，而私有构造函数调用相应 <code>__shared_ptr</code> 的保护构造函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptr_base.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">__shared_ptr(_Sp_alloc_shared_tag&lt;_Alloc&gt; __tag, _Args&amp;&amp;... __args)</span><br><span class="line">: _M_ptr(), _M_refcount(_M_ptr, __tag, std::forward&lt;_Args&gt;(__args)...) &#123;</span><br><span class="line">    _M_enable_shared_from_this_with(_M_ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shared_ptr_base.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, <span class="keyword">typename</span>... _Args&gt;</span><br><span class="line">__shared_count(_Tp*&amp; __p, _Sp_alloc_shared_tag&lt;_Alloc&gt; __a, _Args&amp;&amp;... __args) &#123;</span><br><span class="line">    <span class="keyword">typedef</span> _Sp_counted_ptr_inplace&lt;_Tp, _Alloc, _Lp&gt; _Sp_cp_type;</span><br><span class="line">    <span class="comment">// __a._M_a 是 std::allocator</span></span><br><span class="line">    <span class="keyword">typename</span> _Sp_cp_type::__allocator_type __a2(__a._M_a);</span><br><span class="line">    <span class="comment">// 只分配一次空间，返回一个 __allocated_ptr</span></span><br><span class="line">    <span class="keyword">auto</span> __guard = std::__allocate_guarded(__a2);</span><br><span class="line">    _Sp_cp_type* __mem = __guard.<span class="built_in">get</span>();</span><br><span class="line">    <span class="comment">// placement new</span></span><br><span class="line">    <span class="keyword">auto</span> __pi = ::<span class="built_in">new</span> (__mem) _Sp_cp_type(__a._M_a, std::forward&lt;_Args&gt;(__args)...);</span><br><span class="line">    __guard = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// _Sp_counted_ptr_inplace 是 _Sp_counted_base 子类</span></span><br><span class="line">    _M_pi = __pi;</span><br><span class="line">    <span class="comment">// 这里 __p 是引用变量，给外面的 _M_ptr 赋值</span></span><br><span class="line">    __p = __pi-&gt;_M_ptr();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc, _Lock_policy _Lp&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_Sp_counted_ptr_inplace</span> <span class="keyword">final</span> : <span class="keyword">public</span> _Sp_counted_base&lt;_Lp&gt; &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">_Impl</span> : _Sp_ebo_helper&lt;<span class="number">0</span>, _Alloc&gt; &#123;</span><br><span class="line">        <span class="keyword">typedef</span> _Sp_ebo_helper&lt;<span class="number">0</span>, _Alloc&gt;	_A_base;</span><br><span class="line"></span><br><span class="line">        __gnu_cxx::__aligned_buffer&lt;_Tp&gt; _M_storage;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    _Impl _M_impl;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>构造 <code>__shared_count</code> 时，通过引入 <code>_Sp_counted_ptr_inplace</code> 将原始数据和控制块组合在一起，达到一次分配内存同时创建两个资源的效果</p>
<p>由于 <code>std::make_shared</code> 仅分配一次资源，从而比直接构造 <code>shared_ptr</code> 效率更高</p>
<h3 id="make-shared-劣势"><a href="#make-shared-劣势" class="headerlink" title="make_shared 劣势"></a>make_shared 劣势</h3><p>构造函数是保护或私有时，无法使用 <code>std::make_shared</code></p>
<p><code>std::make_shared</code> 无法指定删除器</p>
<h2 id="shared-ptr-与-unique-ptr-在释放资源时的不同"><a href="#shared-ptr-与-unique-ptr-在释放资源时的不同" class="headerlink" title="shared_ptr 与 unique_ptr 在释放资源时的不同"></a>shared_ptr 与 unique_ptr 在释放资源时的不同</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Test &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Object</span> &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> pointer = std::shared_ptr&lt;Object&gt;;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Object</span>() &#123;</span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;destruct Object&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ~Object() &#123;</span></span><br><span class="line">    <span class="comment">//   std::cout &lt;&lt; &quot;destruct Object&quot; &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// &#125;;</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">RealObject</span>: <span class="keyword">public</span> Object &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">RealObject</span>(<span class="type">const</span> std::string&amp; str) &#123;</span><br><span class="line">	    str_ = str;</span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;construct &quot;</span> &lt;&lt; str_ &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">RealObject</span>() &#123;</span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;destruct &quot;</span> &lt;&lt; str_ &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    std::string str_;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">testCase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::shared_ptr&lt;Object&gt; sObj = std::<span class="built_in">make_shared</span>&lt;RealObject&gt;(<span class="string">&quot;shared_ptr&quot;</span>);</span><br><span class="line">    std::unique_ptr&lt;Object&gt; uObj = std::<span class="built_in">make_unique</span>&lt;RealObject&gt;(<span class="string">&quot;unique_ptr&quot;</span>);</span><br><span class="line">    Object* rObj = <span class="keyword">new</span> <span class="built_in">RealObject</span>(<span class="string">&quot;raw_ptr&quot;</span>);</span><br><span class="line">    <span class="keyword">delete</span> rObj;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  Test::<span class="built_in">testCase</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">非虚基类析构函数</span></span><br><span class="line"><span class="comment">construct shared_ptr</span></span><br><span class="line"><span class="comment">construct unique_ptr</span></span><br><span class="line"><span class="comment">construct raw_ptr</span></span><br><span class="line"><span class="comment">destruct Object</span></span><br><span class="line"><span class="comment">destruct Object</span></span><br><span class="line"><span class="comment">destruct shared_ptr</span></span><br><span class="line"><span class="comment">destruct Object</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">虚析构函数</span></span><br><span class="line"><span class="comment">construct shared_ptr</span></span><br><span class="line"><span class="comment">construct unique_ptr</span></span><br><span class="line"><span class="comment">construct raw_ptr</span></span><br><span class="line"><span class="comment">destruct raw_ptr</span></span><br><span class="line"><span class="comment">destruct Object</span></span><br><span class="line"><span class="comment">destruct unique_ptr</span></span><br><span class="line"><span class="comment">destruct Object</span></span><br><span class="line"><span class="comment">destruct shared_ptr</span></span><br><span class="line"><span class="comment">destruct Object</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>从 demo 的输出结果，可以得到下面结论</p>
<ol>
<li><p>当基类析构函数是虚函数时，<code>std::shared_ptr</code> 和 <code>std::unique_ptr</code> 都能正确释放资源</p>
</li>
<li><p>当基类析构函数不是虚函数时，<code>std::shared_ptr</code> 可以正确释放资源，而 <code>std::unique_ptr</code> 没能正确释放子类资源</p>
</li>
<li><p><code>std::shared_ptr</code> 在两种情况下都能正确释放资源，是因为能够正确调用子类析构函数</p>
</li>
<li><p><code>std::unique_ptr</code> 在基类析构函数不是虚函数时，只会调用父类析构函数，这跟原始指针的行为时一致的</p>
</li>
</ol>
<p>造成 <code>std::shared_ptr</code> 和 <code>std::unqiue_ptr</code> 在释放资源上不同的原因在它们的构造函数</p>
<p>先来看 <code>std::shared_ptr</code> 的构造函数</p>
<img src="/2023/12/15/cpp%E7%BB%86%E8%8A%82-shared-ptr%E7%9B%B8%E5%85%B3%E7%BB%86%E8%8A%82/1.jpeg" class="">

<p>从图中可以看到 <code>std::shared_ptr</code> 的构造函数是模板函数，因此内部保存了传入的原始指针类型</p>
<p>再来看 <code>std::unique_ptr</code> 的构造函数</p>
<img src="/2023/12/15/cpp%E7%BB%86%E8%8A%82-shared-ptr%E7%9B%B8%E5%85%B3%E7%BB%86%E8%8A%82/2.png" class="">

<p><code>std::unique_ptr</code> 先内部定一个了一个 <code>pointer</code> 类型，该类型取决于 <code>_Tp</code></p>
<img src="/2023/12/15/cpp%E7%BB%86%E8%8A%82-shared-ptr%E7%9B%B8%E5%85%B3%E7%BB%86%E8%8A%82/3.png" class="">

<p><code>std::unique_ptr</code> 的构造函数都只接受 <code>pointer</code> 类型，因此内部只保存了模板类参数类型的指针，所以当父类析构函数非虚函数时，只会调用父类的析构函数</p>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p><code>shared_ptr</code> 中有两个指针，一个指向所管理数据的地址，另一个指向执行控制块的地址</p>
<h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>执行控制块包括对关联资源的引用计数以及弱引用计数等</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;_Lock_policy _Lp = __default_lock_policy&gt;</span><br><span class="line">    <span class="keyword">class</span> _Sp_counted_base</span><br><span class="line">    : <span class="keyword">public</span> _Mutex_base&lt;_Lp&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">      _Sp_counted_base() <span class="keyword">noexcept</span></span><br><span class="line">      : _M_use_count(<span class="number">1</span>), _M_weak_count(<span class="number">1</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_add_ref_copy()</span><br><span class="line">      &#123; __gnu_cxx::__atomic_add_dispatch(&amp;_M_use_count, <span class="number">1</span>); &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_release() <span class="keyword">noexcept</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_use_count);</span><br><span class="line">        <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_use_count, <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_use_count);</span><br><span class="line">            _M_dispose();</span><br><span class="line">            <span class="comment">// There must be a memory barrier between dispose() and destroy()</span></span><br><span class="line">            <span class="comment">// to ensure that the effects of dispose() are observed in the</span></span><br><span class="line">            <span class="comment">// thread that runs destroy().</span></span><br><span class="line">            <span class="comment">// See http://gcc.gnu.org/ml/libstdc++/2005-11/msg00136.html</span></span><br><span class="line">            <span class="keyword">if</span> (_Mutex_base&lt;_Lp&gt;::_S_need_barriers)</span><br><span class="line">              &#123;</span><br><span class="line">                __atomic_thread_fence (__ATOMIC_ACQ_REL);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Be race-detector-friendly.  For more info see bits/c++config.</span></span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_weak_count);</span><br><span class="line">            <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_weak_count,</span><br><span class="line">                                                       <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">              &#123;</span><br><span class="line">                _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_weak_count);</span><br><span class="line">                _M_destroy();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_weak_add_ref() <span class="keyword">noexcept</span></span><br><span class="line">      &#123; __gnu_cxx::__atomic_add_dispatch(&amp;_M_weak_count, <span class="number">1</span>); &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span></span><br><span class="line">      _M_weak_release() <span class="keyword">noexcept</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Be race-detector-friendly. For more info see bits/c++config.</span></span><br><span class="line">        _GLIBCXX_SYNCHRONIZATION_HAPPENS_BEFORE(&amp;_M_weak_count);</span><br><span class="line">        <span class="keyword">if</span> (__gnu_cxx::__exchange_and_add_dispatch(&amp;_M_weak_count, <span class="number">-1</span>) == <span class="number">1</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            _GLIBCXX_SYNCHRONIZATION_HAPPENS_AFTER(&amp;_M_weak_count);</span><br><span class="line">            <span class="keyword">if</span> (_Mutex_base&lt;_Lp&gt;::_S_need_barriers)</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="comment">// See _M_release(),</span></span><br><span class="line">                <span class="comment">// destroy() must observe results of dispose()</span></span><br><span class="line">                __atomic_thread_fence (__ATOMIC_ACQ_REL);</span><br><span class="line">              &#125;</span><br><span class="line">            _M_destroy();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span></span><br><span class="line">      _M_get_use_count() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 使用 relaxed 模型，与其他线程没有同步关系</span></span><br><span class="line">        <span class="keyword">return</span> __atomic_load_n(&amp;_M_use_count, __ATOMIC_RELAXED);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">      _Atomic_word  _M_use_count;     <span class="comment">// #shared</span></span><br><span class="line">      _Atomic_word  _M_weak_count;    <span class="comment">// #weak + (#shared != 0)</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="修改指向"><a href="#修改指向" class="headerlink" title="修改指向"></a>修改指向</h3><p>多线程代码操作的是同一个 <code>shared_ptr</code> 的对象，多个线程同时读是安全的，多个线程同时读写是不安全的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">fn</span><span class="params">(shared_ptr&lt;A&gt;&amp; sp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (..) &#123;</span><br><span class="line">        sp = other_sp;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (...) &#123;</span><br><span class="line">        sp = other_sp2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::thread <span class="title">td</span><span class="params">(fn, std::ref(sp1))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">修改指向，sp 原先指向的引用计数的值要 -1，other_sp 指向的引用计数值要 +1，这几步操作加起来并不是一个原子操作</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">如果多个线程都在修改 sp 的指向的时候，那么有可能会出问题。比如在导致计数在操作 -1 的时候，其内部的指向已经被其他线程修改过了，引用计数的异常会导致某个管理的对象被提前析构，后续在使用到该数据的时候触发coredump</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>多线程代码操作的不是同一个 <code>shared_ptr</code> 的对象，但管理的数据是同一份，该对象是线程安全的，但不意味着管理的对象时线程安全的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">fn</span><span class="params">(shared_ptr&lt;A&gt; sp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (..) &#123;</span><br><span class="line">        sp = other_sp;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (...) &#123;</span><br><span class="line">        sp = other_sp2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::thread <span class="title">td</span><span class="params">(fn, sp1)</span></span>;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/13/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-watch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/13/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-watch/" class="post-title-link" itemprop="url">watch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-13 17:08:18" itemprop="dateCreated datePublished" datetime="2023-12-13T17:08:18+08:00">2023-12-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-%E5%91%BD%E4%BB%A4%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">Linux 命令行</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>定期执行程序，展示输出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">watch [options] <span class="built_in">command</span></span><br><span class="line">-d 高亮显示变化的区域</span><br><span class="line">-n 刷新间隔</span><br><span class="line"></span><br><span class="line">watch -d <span class="built_in">ls</span> -l</span><br><span class="line">watch -d <span class="string">&#x27;ls -l | fgrep joe&#x27;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/13/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-mpstat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/13/Linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7-mpstat/" class="post-title-link" itemprop="url">mpstat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-13 14:10:44" itemprop="dateCreated datePublished" datetime="2023-12-13T14:10:44+08:00">2023-12-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-%E5%91%BD%E4%BB%A4%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">Linux 命令行</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，以及所有 CPU 的平均指标</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mpstat [ -A ] [ -n ] [ -u ] [ -V ] [ -I &#123; keyword [,...] | ALL &#125; ] [ -N &#123; node_list | ALL &#125; ] [ -o JSON ] [ -P &#123; cpu_list | ALL &#125; ] [ interval [ count ] ]</span><br><span class="line"></span><br><span class="line">-P 指定 CPU 列表，格式 0,2,4-7,12-</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示结果</span></span><br><span class="line">%user 用户态的 CPU 时间</span><br><span class="line">%<span class="built_in">nice</span> <span class="built_in">nice</span> 值为负进程的 CPU 时间</span><br><span class="line">%sys 内核时间</span><br><span class="line">%iowait 硬盘 IO 等待时间</span><br><span class="line">%irq 硬中断时间</span><br><span class="line">%soft 软中断时间</span><br><span class="line">%idle 除去等待磁盘 IO 操作外的因为任何原因而空闲的时间闲置时间</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-LinuxCPU%E6%80%A7%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-LinuxCPU%E6%80%A7%E8%83%BD/" class="post-title-link" itemprop="url">Linux CPU 性能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-13 13:36:19" itemprop="dateCreated datePublished" datetime="2023-12-13T13:36:19+08:00">2023-12-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E6%80%A7%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">Linux性能</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="平均负载"><a href="#平均负载" class="headerlink" title="平均负载"></a>平均负载</h2><p>平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系</p>
<h3 id="可运行状态"><a href="#可运行状态" class="headerlink" title="可运行状态"></a>可运行状态</h3><p>可运行状态的进程，是指正在使用 CPU 或者正在等待 CPU 的进程，也就是用 ps 命令看到的处于 R 状态（Running 或 Runnable）的进程</p>
<h3 id="不可中断状态"><a href="#不可中断状态" class="headerlink" title="不可中断状态"></a>不可中断状态</h3><p>不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I&#x2F;O 响应，也就是在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程</p>
<p>当一个进程向磁盘读写数据时，为了保证数据的一致性，在得到磁盘回复前，它是不能被其他进程或者中断打断的，这个时候的进程就处于不可中断状态</p>
<p>不可中断状态实际上是系统对进程和硬件设备的一种保护机制</p>
<h3 id="与-CPU-负载关系"><a href="#与-CPU-负载关系" class="headerlink" title="与 CPU 负载关系"></a>与 CPU 负载关系</h3><p>平均负载不仅包括了正在使用 CPU 的进程，还包括等待 CPU 和等待 I&#x2F;O 的进程</p>
<p>CPU 使用率，是单位时间内 CPU 繁忙情况的统计，跟平均负载并不一定完全对应</p>
<ul>
<li><p>CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的</p>
</li>
<li><p>I&#x2F;O 密集型进程，等待 I&#x2F;O 也会导致平均负载升高，但 CPU 使用率不一定很高</p>
</li>
<li><p>大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高</p>
</li>
</ul>
<h2 id="上下文切换"><a href="#上下文切换" class="headerlink" title="上下文切换"></a>上下文切换</h2><p>过多的上下文切换，会把 CPU 时间消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，缩短进程真正运行的时间</p>
<p>可以使用 <code>vmstat</code> 来查询系统的上下文切换情况，可以使用 <code>pidstat -w</code> 查看每个进程的详细情况</p>
<p>上下文切换分为自愿上下文切换和非自愿上下文切换</p>
<ul>
<li><p>自愿上下文切换是指进程无法获取所需资源，导致的上下文切换。比如说， I&#x2F;O、内存等系统资源不足时，就会发生自愿上下文切换</p>
</li>
<li><p>非自愿上下文切换，则是指进程由于时间片已到等原因，被系统强制调度，进而发生的上下文切换。比如说，大量进程都在争抢 CPU 时，就容易发生非自愿上下文切换</p>
</li>
</ul>
<h2 id="中断情况"><a href="#中断情况" class="headerlink" title="中断情况"></a>中断情况</h2><p>从 &#x2F;proc&#x2F;interrupts 这个只读文件中读取系统中断情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -d <span class="built_in">cat</span> /proc/interrupts</span><br></pre></td></tr></table></figure>

<h2 id="CPU-负载指标"><a href="#CPU-负载指标" class="headerlink" title="CPU 负载指标"></a>CPU 负载指标</h2><ul>
<li><p>us，代表用户态 CPU 时间。不包括下面的 nice 时间，但包括了 guest 时间</p>
</li>
<li><p>ni，代表低优先级用户态 CPU 时间，也就是进程的 nice 值被调整为 1-19 之间时的 CPU 时间。这里注意，nice 可取值范围是 -20 到 19，数值越大，优先级反而越低</p>
</li>
<li><p>sys，代表内核态 CPU 时间</p>
</li>
<li><p>idle，通常缩写为 id，代表空闲时间，不包括等待 I&#x2F;O 的时间</p>
</li>
<li><p>iowait，通常缩写为 wa，代表等待 I&#x2F;O 的 CPU 时间</p>
</li>
<li><p>irq，通常缩写为 hi，代表处理硬中断的 CPU 时间</p>
</li>
<li><p>softirq，通常缩写为 si，代表处理软中断的 CPU 时间</p>
</li>
<li><p>steal，通常缩写为 st，代表当系统运行在虚拟机中的时候，被其他虚拟机占用的 CPU 时间</p>
</li>
<li><p>guest，代表通过虚拟化运行其他操作系统的时间，也就是运行虚拟机的 CPU 时间</p>
</li>
<li><p>guest_nice，通常缩写为 gnice，代表以低优先级运行虚拟机的时间</p>
</li>
</ul>
<p>用户 CPU 和 Nice CPU 高，说明用户态进程占用了较多的 CPU，所以应该着重排查进程的性能问题</p>
<p>系统 CPU 高，说明内核态占用了较多的 CPU，所以应该着重排查内核线程或者系统调用的性能问题</p>
<p>I&#x2F;O 等待 CPU 高，说明等待 I&#x2F;O 的时间比较长，所以应该着重排查系统存储是不是出现了 I&#x2F;O 问题</p>
<p>软中断和硬中断高，说明软中断或硬中断的处理程序占用了较多的 CPU，所以应该着重排查内核中的中断服务程序</p>
<h2 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h2><ul>
<li><p>R 进程在 CPU 的就绪队列中，正在运行或者正在等待运行</p>
</li>
<li><p>D 不可中断状态睡眠，一般表示进程正在跟硬件交互，并且交互过程不允许被其他进程或中断打断</p>
</li>
<li><p>Z 僵尸进程，也就是进程实际上已经结束了，但是父进程还没有回收它的资源</p>
</li>
<li><p>S 可中断状态睡眠，表示进程因为等待某个事件而被系统挂起。当进程等待的事件发生时，它会被唤醒并进入 R 状态</p>
</li>
<li><p>I 空闲状态，用在不可中断睡眠的内核线程上</p>
</li>
<li><p>T 进程处于暂停或者跟踪状态</p>
</li>
<li><p>X 进程已经消亡</p>
</li>
</ul>
<p>D 状态的进程会导致平均负载升高，I 状态的进程却不会</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://chaxxro.github.io/2023/12/06/cpp%E7%BB%86%E8%8A%82-CRTP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaxxro">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="也无风雨也无晴">
      <meta itemprop="description" content="好记性不如烂键盘">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 也无风雨也无晴">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/12/06/cpp%E7%BB%86%E8%8A%82-CRTP/" class="post-title-link" itemprop="url">CRTP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-06 20:06:13" itemprop="dateCreated datePublished" datetime="2023-12-06T20:06:13+08:00">2023-12-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-22 18:04:21" itemprop="dateModified" datetime="2024-07-22T18:04:21+08:00">2024-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cpp/" itemprop="url" rel="index"><span itemprop="name">cpp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>CRTP 是 Curiously Recurring Template Pattern 的缩写，中文译为奇异的递归模板模式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">interface</span><span class="params">()</span> </span>&#123; <span class="built_in">static_cast</span>&lt;T *&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">imp</span>(); &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base&lt;Derived&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">imp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 即使没有声明 virtual 函数也实现了多态的功能</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;in Derived::imp&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Base&lt;Derived&gt; b;</span><br><span class="line">  d.<span class="built_in">interface</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Base</code> 类的 <code>interface</code> 中使用 <code>static_cast</code> 进行类型转换，从而调用派生类的成员函数。如果使用 <code>dynamic_cast</code> 则转换会发生在运行时，而模板是在编译器就进行了实例化</p>
<p>CRTP 总结起来，其有以下两个特点：</p>
<ul>
<li><p>继承自模板类</p>
</li>
<li><p>派生类将自身作为参数传给模板类</p>
</li>
</ul>
<h2 id="颠倒继承"><a href="#颠倒继承" class="headerlink" title="颠倒继承"></a>颠倒继承</h2><p>对于 CRTP，在基类中调用派生类的成员函数，扩展了基类的功能。而对于普通继承，则是派生类中调用基类的成员函数，扩展了派生类的功能</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="静态多态"><a href="#静态多态" class="headerlink" title="静态多态"></a>静态多态</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">interface</span><span class="params">()</span> </span>&#123; <span class="built_in">static_cast</span>&lt;T *&gt;(<span class="keyword">this</span>)-&gt;<span class="built_in">imp</span>(); &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">imp</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;in Base::imp&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived1</span> : <span class="keyword">public</span> Base&lt;Derived1&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">imp</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;in Derived1::imp&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived2</span> : <span class="keyword">public</span> Base&lt;Derived2&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">imp</span><span class="params">()</span> </span>&#123; std::cout &lt;&lt; <span class="string">&quot;in Derived2::imp&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived3</span> : <span class="keyword">public</span> Base&lt;Derived3&gt; &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(T &amp;base)</span> </span>&#123; base.<span class="built_in">interface</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Derived1 d1;</span><br><span class="line">  Derived2 d2;</span><br><span class="line">  Derived3 d3;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fun</span>(d1);</span><br><span class="line">  <span class="built_in">fun</span>(d2);</span><br><span class="line">  <span class="built_in">fun</span>(d3);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">in Derived1::imp</span></span><br><span class="line"><span class="comment">in Derived2::imp</span></span><br><span class="line"><span class="comment">in Base::imp</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="代码复用"><a href="#代码复用" class="headerlink" title="代码复用"></a>代码复用</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PrintType</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">typeid</span>(*<span class="keyword">this</span>).<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PrintType</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">typeid</span>(*<span class="keyword">this</span>).<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived1</span> : <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">PrintType</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">typeid</span>(*<span class="keyword">this</span>).<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintType</span><span class="params">(<span class="type">const</span> Base &amp;base)</span> </span>&#123; base.<span class="built_in">PrintType</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Derived d;</span><br><span class="line">  Derived1 d1;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">PrintType</span>(d);</span><br><span class="line">  <span class="built_in">PrintType</span>(d1);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 借助 CRTP</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PrintType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T &amp;t = <span class="built_in">static_cast</span>&lt;T &amp;&gt;(*<span class="keyword">this</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">typeid</span>(t).<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base&lt;Derived&gt; &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived1</span> : <span class="keyword">public</span> Base&lt;Derived1&gt; &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="type">void</span> <span class="title">PrintType</span><span class="params">(T base)</span> </span>&#123; base.<span class="built_in">PrintType</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Derived d;</span><br><span class="line">  Derived1 d1;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">PrintType</span>(d);</span><br><span class="line">  <span class="built_in">PrintType</span>(d1);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><h3 id="容器存储"><a href="#容器存储" class="headerlink" title="容器存储"></a>容器存储</h3><p><code>Base</code> 类实际上是一个模板类，而不是一个实际的类。因此，如果存在名为 <code>Derived</code> 和 <code>Derived1</code> 的派生类，则基类模板初始化将具有不同的类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两个类型的指针</span></span><br><span class="line">Base&lt;Derived&gt; *b = <span class="keyword">new</span> Derived;</span><br><span class="line">Base&lt;Derived&gt; *b1 = <span class="keyword">new</span> Derived1;</span><br></pre></td></tr></table></figure>

<p>因为基于 CRTP 方式的指针具有不同的类型，所以不能将 CRTP 基类指针存储在容器中</p>
<h3 id="堆栈溢出"><a href="#堆栈溢出" class="headerlink" title="堆栈溢出"></a>堆栈溢出</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PrintType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T &amp;t = <span class="built_in">static_cast</span>&lt;T &amp;&gt;(*<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    t.<span class="built_in">PrintType</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base&lt;Derived&gt; &#123;</span><br><span class="line">  <span class="comment">// 此处没有实现PrintType()函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Derived d;</span><br><span class="line">  d.<span class="built_in">PrintType</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果派生类没有实现某个基类中定义的函数，那么调用的是基类的函数，这样容易导致递归调用引起堆栈溢出</p>
<p>可以在基类中重新定义另外一个函数，这样在调用函数时，如果派生类中没有实现这个函数，则会调用基类的另一个函数，这样就避免了因为递归调用而导致的堆栈溢出问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">Base</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PrintType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T &amp;t = <span class="built_in">static_cast</span>&lt;T &amp;&gt;(*<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    t.<span class="built_in">PrintTypeImpl</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">PrintTypeImpl</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base&lt;Derived&gt; &#123;</span><br><span class="line">  <span class="comment">// 此处没有实现PrintTypeImpl()函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Derived d;</span><br><span class="line"></span><br><span class="line">  d.<span class="built_in">PrintType</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaxxro</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
