---
toc:
  enable: true
  number: false
  max_depth: 3
title: 大内存服务的 coredump 优化方案
date: 2024-08-07 17:20:32
tags: 问题分析
categories: 问题分析
---

## 背景

服务本地加载各种数据导致内存占用比较大，因此产生的 coredump 巨大，这样会带来以下弊端：

- coredump 文件磁盘占用巨大，云上服务节点如果没有这么大的本地磁盘，coredump 就会截断，导致无法查看白白浪费空间，同时也容易将本地磁盘占满，造成服务以及 POD 状态异常

- 即使落盘到 CFS，磁盘空间宽裕，但也需要额外机制保证文件个数和写入频率

- 巨大文件的落盘耗时较长，影响服务迅速拉起，造成故障时长较长

## 方案

内部有一个 segv_api 方案，关闭 coredump，程序只打印内存地址范围，以及堆栈内存地址，通过脚本工具还原堆栈符号

因为不会产生巨大的 coredump 文件，所以会给调试带来不便，线程信息、寄存器信息、堆栈内存、变量取值都将无法看到，但还是推荐使用此类方案：

- 针对大部分 SIGSEGV 段错误，一般使用堆栈符号就能定位

- 针对多线程和内存泄漏的问题，即使有全量 coredump 也很难直接定位问题，因为奔溃的位置一般都不是事发现场



