---
toc:
  enable: true
  number: false
  max_depth: 3
title: Feed 流设计
date: 2023-06-06 16:32:41
tags: 后端设计
categories: 后端设计
---

Feed 流是将用户主动订阅的若干消息源组合在一起形成内容聚合器，帮助用户持续地获取最新的订阅源内容

简而言之，Feed 流就是持续更新并呈现给用户内容的信息流

## 展现形式

- timeline 是最典型的 Feed 流展示方式，它按照内容更新的时间先后顺序将内容展示给用户

- rank 即按照某些因素计算内容的权重，从而决定内容展示的先后顺序

- aggregate 聚合类型，比如几个朋友看了一部电影，这就可以聚合为一条 Feed

- notice 通知类型，一般用于各种通知、私信等场景

## timeline 设计

### 拉模型

用户刷新时，服务先查询用户所有关注的 uid，根据 uid 查询发布的内容，再按照发布时间进行排序

因为拉模型每次都需要读取所有关注的内容，因此拉模型也称为读扩散

- 拉模型不需要额外的存储，每次发布只需写入一条数据

- 用户增删关注只需操作关注列表，没有额外操作

- 头部发布者不需要特殊处理

- 因为每次拉取都需要大量读取数据和排序，关注数较多时耗时增加明显

### 推模型

内容发布者发布新内容时，对粉丝的 timeline 进行写入，因此也被称为写扩散

- 推模型的拉取操作简单高效

- 推模型的发布操作逻辑复杂，不仅需要更新内容，在新增、取消关注的时候也需要额外逻辑处理

- 头部发布者的写入量巨大

### 模型对比

||优点|缺点|
|-|-|-|
|拉模型|逻辑简单，节约存储空间|读取效率低下
|推模型|读取操作快|逻辑复杂，消耗大量存储空间

Feed 流是一个极度读写不平衡的场景，这使得拉模型消耗的 CPU 等资源反而更高

推送 Feed 流可以分段进行，但用户很难容忍打开页面时需要较长等候时间，因此拉模型读取效率低下的缺点使得它的应用受到了极大限制

针对头部发布者，可以有选择地过滤掉一些粉丝来减少写入量

结合以上分析，可以针对在线用户使用推模型，离线用户使用拉模型