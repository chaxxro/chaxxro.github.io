---
toc:
  enable: true
  number: false
  max_depth: 3
title: 一致性哈希
date: 2023-08-10 09:48:52
tags: 后端设计
categories: 后端设计
---

## 背景

假设有 n 台缓存服务器，对于所有的 key，可以对 key 进哈希运算后对 n 取模，即 hash(key) % n

该方案具有一定的局限性，因为生产环境会根据业务量的大小调整服务器数量。当 n 变化时，取模的结果会随之变化。同样的 key 在不同服务器数量下，将计算出不同的结果，从而之前缓存的 key 数据将会失去作用和意义。大量的缓存同一时间失效将造成缓存雪崩，进而导致整个系统不可用

## 一致性哈希原理

一致性哈希是一种特殊的哈希算法，在移除或者添加服务器时，能够尽可能小地改变已存在的服务请求与处理请求服务器之间的映射关系

一致性哈希算法本质上也是一种取模算法，不过不同于按数量取模，一致性哈希是对固定值 2^32 取模

IPv4 的地址是 4 组 8 位 2 进制数组成，所以用 2^32 可以保证每个 IP 地址会有唯一的映射

1. 将 2^32 看成一个圆环，由 2^32 个点组成

2. 对服务器 IP 进行哈希运算后对 2^32 取模，将服务器映射到环上的一个点

3. 对 key 进行哈希运算后对 2^32 取模得到环上对应的点位，如果该点位没有相应的服务器则顺时针在环上找服务器

一致性哈希就是将原本单个点的哈希映射，转变为了在一个环上的某个片段上的映射

## 数据偏斜问题

在实际场景中很难选取到一个哈希函数能够完美地将各个服务器散列到环上，从而在服务器节点数量太少的情况下，很容易因为节点分布不均匀而造成数据倾斜问题

针对数据倾斜问题，可以将每台物理服务器虚拟为一组虚拟服务器，将虚拟服务器放置到哈希环上。如果要确定对象的服务器，需先确定对象的虚拟服务器，再由虚拟服务器确定物理服务器

虚拟节点的哈希计算通常可以采用对应节点的 IP 地址加数字编号后缀的方式，如 10.24.23.227#1 的方式

引入虚拟节点的同时也增加了新的问题，要做虚拟节点和真实节点间的映射

## 使用场景

一致性哈希在分布式系统中应该是实现负载均衡的首选算法，它的实现比较灵活，既可以在客户端实现，也可以在中间件上实现，比如日常使用较多的缓存中间件 memcached 和 redis