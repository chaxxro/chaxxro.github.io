---
toc:
  enable: true
  number: false
  max_depth: 3
title: 限流
date: 2023-07-27 17:15:22
tags: 后端设计
categories: 后端设计
---

限流主要用于在流量突增时保护系统，使系统能够正常运行。在微服务架构中，限流通常应用在 API 接口，防止大流量冲击服务

## 漏桶算法

请求来了之后会首先进到漏斗里，漏斗以恒定的速率将请求流出进行处理，从而起到平滑流量的作用

当请求的流量过大时，漏斗达到最大容量时会溢出，此时请求被丢弃

缺点：

- 漏桶的漏出速率是固定的，可以起到整流的作用，但在流量低时无法有效利用资源

- 不能解决流量突发的问题，即使服务没有负载请求也需要在队列中等待一段时间

## 令牌桶算法

令牌桶算法是对漏斗算法的一种改进，允许一定程度的流量突发

在令牌桶算法中存在一个令牌桶，并且以恒定的速率向令牌桶中放入令牌。令牌桶有一定的容量，如果令牌桶满了令牌则无法放进去

请求会需要先到令牌桶中去拿令牌，如果拿到了令牌，则该请求会被处理，并消耗掉拿到的令牌。如果令牌桶为空，则该请求会被丢弃

## 固定窗口算法

在固定时间段内，只允许固定数量的请求被执行

缺点：

- 流量曲线可能不够平滑，有突刺现象

- 一段时间内（不超过时间窗口）服务可能不可用

- 存在边界双倍问题，恶意用户可以在窗口前置前后发送双倍请求从而瞬间压垮服务

## 滑动窗口算法

滑动窗口解决了固定窗口切换时存在的边界双倍问题

滑动窗口算法将一个计时窗口分成了若干个小窗口，然后每个小窗口维护一个独立的计数器。当请求的时间大于当前窗口的最大时间时，则将计时窗口向前平移一个小窗口。平移时，将第一个小窗口的数据丢弃，然后将第二个小窗口设置为第一个小窗口，同时在最后面新增一个小窗口，将新的请求放在新增的小窗口中

滑动窗口算法其实就是对请求数进行了更细粒度的限流，窗口划分的越多，则限流越精准

## Redis 分布式限流

### 固定窗口
Redis 中的固定窗口限流是使用 `incr`` 命令和时间戳信息作为 key 就可以统计每秒的请求量，以此达到限流目的

`incr`` 和 `expire`` 命令操作应该在一个原子操作中提交，以保证每个 key 都正确设置了过期时间，不然会有 key 值无法自动删除而导致的内存溢出，所以需要用 lua 脚本来实现原子操作

### 滑动窗口

使用 `zset` 有序集合来实现滑动窗口限流