---
toc:
  enable: true
  number: false
  max_depth: 3
title: 零拷贝
date: 2023-07-28 19:37:18
tags: 操作系统
categories: 文件系统
---

零拷贝技术是指计算机执行操作时，CPU 不需要先将数据从某处内存复制到另一个特定区域。这种技术通常用于通过网络传输文件时节省 CPU 周期和内存带宽

- 减少甚至完全避免操作系统内核和用户应用程序地址空间这两者之间进行数据拷贝操作，从而减少上下文切换带来的系统开销

- 减少甚至完全避免操作系统内核缓冲区之间进行数据拷贝操作

- 帮助用户进程绕开操作系统内核空间直接访问硬件存储接口操作数据

- 利用 DMA 而非 CPU 来完成硬件接口和内核缓冲区之间的数据拷贝，从而解放 CPU 使之能去执行其他的任务，提升系统性能

## 减少甚至避免用户空间和内核空间之间的数据拷贝

在一些场景下，用户进程在数据传输过程中并不需要对数据进行访问和处理，那么数据在 Linux 的 Page Cache 和用户进程的缓冲区之间的传输就完全可以避免

让数据拷贝完全在内核里进行，甚至可以通过更巧妙的方式避免在内核里的数据拷贝。这一类实现一般是通过增加新的系统调用来完成的，比如 Linux 中的 `mmap`、`sendfile` 以及 `splice` 等

## 绕过内核的直接 IO

### 用户直接访问硬件

让用户进程能有直接读写硬件设备，在数据传输过程中内核只需要做一些虚拟内存配置相关的工作

这种无需数据拷贝和内核干预的直接 IO 理论上是最高效的数据传输技术，但是它的适用性也非常窄

由于设备之间的数据传输是通过 DMA 完成的，因此用户空间的数据缓冲区内存页必须进行页锁定 page pinning，这是为了防止其物理页框地址被交换到磁盘或者被移动到新的地址而导致 DMA 去拷贝数据的时候在指定的地址找不到内存页从而引发缺页错误，而页锁定的开销并不比 CPU 拷贝小，所以为了避免频繁的页锁定系统调用，应用程序必须分配和注册一个持久的内存池，用于数据缓冲

直接访问硬件还可能会带来严重的安全问题，因为用户进程拥有直接访问硬件的极高权限，所以如果程序设计没有做好的话，可能会消耗本来就有限的硬件资源或者进行非法地址访问，可能也会因此间接地影响其他正在使用同一设备的应用程序

### 内核控制访问硬件

相较于用户直接访问硬件技术，通过内核控制的直接访问硬件技术更加的安全。它比前者在数据传输过程中会多干预一点，但也仅仅是作为一个代理人这样的角色，不会参与到实际的数据传输过程。内核将控制 DMA 去替用户进程做缓冲区的数据传输工作

## 内核缓冲区和用户缓冲区之间的传输优化

### 动态重映射与写时拷贝

写时复制 COW 是如果有多个调用者同时请求相同资源，他们会共同获取相同的指针指向相同的资源，直到某个调用者试图修改资源的内容时，系统才会真正复制一份专用副本给该调用者，而其他调用者所见到的最初的资源仍然保持不变

COW 是一种建构在虚拟内存冲映射技术之上的技术，因此它需要 MMU 的硬件支持

COW 最大的优势是节省内存和减少数据拷贝，不过却是通过增加操作系统内核 IO 过程复杂性作为代价的

## 案例

### Kafka

Kafka 作为一个消息队列，涉及到磁盘 IO 主要有两个操作：

- Producter 向 Kakfa 发送消息，Kakfa 负责将消息以日志的方式持久化落盘

- Consumer 向 Kakfa 进行拉取消息，Kafka 负责从磁盘中读取一批日志消息，然后再通过网卡发送

Kakfa 服务端接收 Producter 的消息并持久化的场景下，使用 `mmap` 基于顺序磁盘 IO 提供高效的持久化能力

 Kakfa 服务端向 Consumer 发送消息的场景下使用 `sendfile`，因为 `sendfile` 基于 Page Cache 实现，如果有多个 Consumer 在同时消费一个主题的消息，那么由于消息一直在 page cache 中进行了缓存，因此只需一次磁盘 IO 就可以服务于多个 Consumer

 ## 大文件读写场景

在大文件传输的场景下，零拷贝技术并不是最优选择。因为在零拷贝的任何一种实现中，都会有 DMA 将数据从磁盘拷贝到内核缓存区这一步
 
在大文件传输场景下，每当访问这些大文件的时候，内核就会把它们载入 PageCache 中，PageCache 空间很快被这些大文件占满。

PageCache 由于长时间被大文件占据，其他小文件可能就无法充分使用到 PageCache，于是这样磁盘读写的性能就会下降了

PageCache 中的大文件数据，由于没有享受到缓存带来的好处，但却耗费 DMA 多拷贝到 PageCache 一次

异步 IO 和直接 IO 的组合能够较好解决大文件的读写