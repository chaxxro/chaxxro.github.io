---
toc:
  enable: true
  number: false
  max_depth: 3
title: 中断
date: 2024-01-09 15:42:33
tags: 操作系统
categories: 进程
---

中断是系统用来响应硬件设备请求的一种机制，它会打断进程的正常调度和执行，然后调用内核中的中断处理程序来响应设备的请求

中断其实是一种异步的事件处理机制，可以提高系统的并发处理能力

由于中断处理程序会打断其他进程的运行，所以，为了减少对正常进程运行调度的影响，中断处理程序就需要尽可能快地运行

中断处理程序在响应中断时，还会临时关闭中断。这就会导致上一次中断处理完成之前，其他中断都不能响应，也就是说中断有可能会丢失

## 软中断

为了解决中断处理程序执行过长和中断丢失的问题，Linux 将中断处理过程分成了两个阶段

- 上半部用来快速处理中断，它在中断禁止模式下运行，主要处理跟硬件紧密相关的或时间敏感的工作。上半部直接处理硬件请求，也就是常说的硬中断，特点是快速执行

- 下半部用来延迟处理上半部未完成的工作，通常以内核线程的方式运行。下半部则是由内核触发，也就是常说的软中断，特点是延迟执行

上半部会打断 CPU 正在执行的任务，然后立即执行中断处理程序。而下半部以内核线程的方式执行，并且每个 CPU 都对应一个软中断内核线程，名字为 ksoftirqd/CPU 编号，比如 0 号 CPU 对应的软中断内核线程的名字就是 ksoftirqd/0

网卡接收到数据包后，会通过硬件中断的方式，通知内核有新的数据到了。这时内核就应该调用中断处理程序来响应它。对上半部来说，既然是快速处理，其实就是要把网卡的数据读到内存中，然后更新一下硬件寄存器的状态（表示数据已经读好了），最后再发送一个软中断信号，通知下半部做进一步的处理。下半部被软中断信号唤醒后，需要从内存中找到网络数据，再按照网络协议栈，对数据进行逐层解析和处理，直到把它送给应用程序

## 查看软中断

`/proc/softirqs` 提供了系统运行以来的累积软中断次数

`/proc/interrupts` 提供了系统运行以来的累积硬中断次数