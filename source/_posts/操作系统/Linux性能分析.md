---
toc:
  enable: true
  number: false
  max_depth: 3
title: Linux性能分析
date: 2023-12-13 13:36:19
tags: 操作系统
categories: Linux性能分析
---

Linux 性能工具图谱

{% asset_img 01.png %}

{% asset_img 02.png %}

## 工具

### 负载

- top

- uptime

### CPU

- mpstat

- pidstat

### IO

- iostat

- iotop

- blktrace

### 内存

- vmstat

### 上下文切换

- vmstat

## 平均负载

平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系

### 可运行状态

可运行状态的进程，是指正在使用 CPU 或者正在等待 CPU 的进程，也就是用 ps 命令看到的处于 R 状态（Running 或 Runnable）的进程

### 不可中断状态

不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程

当一个进程向磁盘读写数据时，为了保证数据的一致性，在得到磁盘回复前，它是不能被其他进程或者中断打断的，这个时候的进程就处于不可中断状态

不可中断状态实际上是系统对进程和硬件设备的一种保护机制

### 与 CPU 负载关系

平均负载不仅包括了正在使用 CPU 的进程，还包括等待 CPU 和等待 I/O 的进程

CPU 使用率，是单位时间内 CPU 繁忙情况的统计，跟平均负载并不一定完全对应

- CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的

- I/O 密集型进程，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高

- 大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高

## 上下文切换

过多的上下文切换，会把 CPU 时间消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，缩短进程真正运行的时间

可以使用 `vmstat` 来查询系统的上下文切换情况，可以使用 `pidstat -w` 查看每个进程的详细情况

上下文切换分为自愿上下文切换和非自愿上下文切换

- 自愿上下文切换是指进程无法获取所需资源，导致的上下文切换。比如说， I/O、内存等系统资源不足时，就会发生自愿上下文切换

- 非自愿上下文切换，则是指进程由于时间片已到等原因，被系统强制调度，进而发生的上下文切换。比如说，大量进程都在争抢 CPU 时，就容易发生非自愿上下文切换

## CPU 负载指标

- us，代表用户态 CPU 时间。不包括下面的 nice 时间，但包括了 guest 时间

- ni，代表低优先级用户态 CPU 时间，也就是进程的 nice 值被调整为 1-19 之间时的 CPU 时间。这里注意，nice 可取值范围是 -20 到 19，数值越大，优先级反而越低

- sys，代表内核态 CPU 时间

- idle，通常缩写为 id，代表空闲时间，不包括等待 I/O 的时间

- iowait，通常缩写为 wa，代表等待 I/O 的 CPU 时间

- irq，通常缩写为 hi，代表处理硬中断的 CPU 时间

- softirq，通常缩写为 si，代表处理软中断的 CPU 时间

- steal，通常缩写为 st，代表当系统运行在虚拟机中的时候，被其他虚拟机占用的 CPU 时间

- guest，代表通过虚拟化运行其他操作系统的时间，也就是运行虚拟机的 CPU 时间

- guest_nice，通常缩写为 gnice，代表以低优先级运行虚拟机的时间

## 进程状态

- R 进程在 CPU 的就绪队列中，正在运行或者正在等待运行

- D 不可中断状态睡眠，一般表示进程正在跟硬件交互，并且交互过程不允许被其他进程或中断打断

- Z 僵尸进程，也就是进程实际上已经结束了，但是父进程还没有回收它的资源

- S 可中断状态睡眠，表示进程因为等待某个事件而被系统挂起。当进程等待的事件发生时，它会被唤醒并进入 R 状态

- I 空闲状态，用在不可中断睡眠的内核线程上

- T 进程处于暂停或者跟踪状态

- X 进程已经消亡

D 状态的进程会导致平均负载升高，I 状态的进程却不会
